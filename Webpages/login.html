<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login Form</title>
  <style>
      body {
          padding-top: 60px;
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          margin: 0;
          background-color: #f8f8f8;
      }

      .top-bar {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 60px;
          background-color: #AF2630;
          z-index: 1000;
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 0 20px;
      }

      .container {
          margin-top: 20px;
          display: flex;
          flex-direction: column;
          align-items: center;
      }

      .column {
          margin-bottom: 20px;
      }

      .col-12 {
          width: 100%; 
          text-align: center;
      }

      .Welcome img {
          width: 700px;
          height: 250px;
          margin-bottom: 20px;
      }

      .rounded-input {
          border-radius: 20px;
          border: 2px solid #ccc;
          padding: 20px;
          width: 300px;
          font-size: 25px;
          font-weight: 600;
          font-family: 'inter';
          text-align: center;
          margin-bottom: 15px;
      }

      /* Password field container */
      .password-container {
          position: relative;
          width: 100%;
          display: flex;
          justify-content: center;
      }

      /* Eye icon styling */
      .password-toggle {
          position: absolute;
          right: 20px;
          top: 50%;
          transform: translateY(-50%);
          cursor: pointer;
          color: #666;
          font-size: 20px;
          z-index: 10;
          background: none;
          border: none;
          padding: 0;
          display: flex;
          align-items: center;
          justify-content: center;
      }

      .password-toggle:hover {
          color: #AF2630;
      }

      .Loginbutton {
          text-align: center;
          margin-top: 20px;
      }

      .Login {
          padding: 20px;
          width: 200px;
          font-size: 25px;
          font-family: 'inter';
          border-radius: 20px;
          border: 2px solid #ccc;
          color: white;
          background-color: #AF2630;
          cursor: pointer;
          font-weight: bold;
      }

      .dashboard-link {
          margin-top: 15px;
          text-align: center;
      }

      .dashboard-link a {
          color: #AF2630;
          font-size: 18px;
          font-family: 'inter';
          text-decoration: none;
          font-weight: 500;
          transition: all 0.3s ease;
      }

      .dashboard-link a:hover {
          text-decoration: underline;
          opacity: 0.8;
      }

      .fbbutton, .gbutton{
          background-color: transparent;
          border: none;
          cursor: pointer;
      }

      .fbbutton img{
          width: 50px;
          height: 50px;
          
      }
      .gbutton img{
          width: 50px;
          height: 50px;
          
      }
      
      .altLogin{
          font-size: 20px;
          font-family: 'inter';
          text-align: center;
      }
      .regis-here {
          font-size: 20px;
          font-family: 'inter';
          margin-top: 15px;
          cursor: pointer;
          color: #AF2630;
          text-decoration: underline;
          padding-left: 5px;
          text-align: center;
      }
      .fpw {
          font-size: 20px;
          font-family: 'inter';
          margin-top: 15px;
          cursor: pointer;
          color: #AF2630;
          text-decoration: underline;
          padding-left: 5px;
          text-align: center;
      }
      .custom-alert {
          display: none;
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background-color: white;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
          z-index: 1001;
      }

      .custom-alert-content {
          text-align: center;
      }

      .custom-alert-header {
          font-size: 18px;
          font-weight: bold;
          margin-bottom: 10px;
          color: #AF2630;
      }

      .custom-alert-body {
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 10px;
      }

      .custom-alert button {
          background-color: #AF2630;
          color: white;
          border: none;
          padding: 8px 15px;
          border-radius: 5px;
          cursor: pointer;
      }
      
      /* Delinquent Modal Styles */
      .delinquent-modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 9999;
      }

      .delinquent-content {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background-color: #fff;
          padding: 30px;
          border-radius: 10px;
          width: 80%;
          max-width: 500px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
          text-align: center;
      }

      .close-modal {
          position: absolute;
          top: 10px;
          right: 15px;
          font-size: 24px;
          font-weight: bold;
          color: #333;
          cursor: pointer;
      }

      .delinquent-content h2 {
          font-size: 24px;
          margin-bottom: 15px;
          color: #AF2630;
      }

      .delinquent-content p {
          font-size: 16px;
          margin: 10px 0;
          line-height: 1.5;
      }

      .delinquent-content .amount {
          font-size: 22px;
          font-weight: bold;
          color: #AF2630;
          margin: 15px 0;
      }

      .pay-now-btn {
          background-color: #AF2630;
          color: white;
          border: none;
          padding: 12px 25px;
          border-radius: 5px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          margin-top: 15px;
          transition: background-color 0.3s;
      }

      .pay-now-btn:hover {
          background-color: #8f1d25;
      }
      
      /* Debug panel styles */
      #debug-panel {
          display: none;
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background-color: rgba(0, 0, 0, 0.8);
          color: #00ff00;
          font-family: monospace;
          padding: 10px;
          max-height: 200px;
          overflow-y: auto;
          z-index: 9999;
      }
      
      #debug-panel pre {
          margin: 0;
          white-space: pre-wrap;
      }
      
      #debug-toggle {
          position: fixed;
          bottom: 10px;
          right: 10px;
          background-color: #333;
          color: white;
          border: none;
          border-radius: 50%;
          width: 30px;
          height: 30px;
          font-size: 16px;
          cursor: pointer;
          z-index: 10000;
      }
      
      /* Emergency login button */
      #emergency-login {
          position: fixed;
          bottom: 10px;
          left: 10px;
          background-color: #AF2630;
          color: white;
          border: none;
          border-radius: 5px;
          padding: 8px 15px;
          font-size: 14px;
          cursor: pointer;
          z-index: 10000;
          display: none;
      }
      
      /* Session info panel */
      #session-info {
          position: fixed;
          top: 70px;
          right: 10px;
          background-color: rgba(0, 0, 0, 0.7);
          color: #00ff00;
          padding: 10px;
          border-radius: 5px;
          font-family: monospace;
          font-size: 12px;
          max-width: 300px;
          z-index: 9999;
          display: none;
      }

      .pay-dues-btn {
          background-color: white;
          color: #AF2630;
          border: none;
          padding: 8px 15px;
          border-radius: 5px;
          font-size: 14px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s ease;
          margin-left: auto;
          margin-right: 30px;
      }

      .pay-dues-btn:hover {
          background-color: #f0f0f0;
          transform: scale(1.05);
      }

      /* Add styles for the dues check modal */
      .dues-check-modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 1001;
      }

      .dues-check-content {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background-color: #fff;
          padding: 32px 28px 28px 28px;
          border-radius: 12px;
          width: 90%;
          max-width: 400px;
          text-align: center;
          box-shadow: 0 4px 24px rgba(0,0,0,0.12);
      }

      .dues-check-content h2 {
          color: #AF2630;
          margin-bottom: 18px;
          font-size: 1.5rem;
          font-weight: 700;
      }

      .dues-check-content p {
          color: #333;
          margin-bottom: 22px;
          font-size: 1rem;
      }

      .dues-check-content input {
          width: 100%;
          padding: 12px 14px;
          margin: 10px 0 18px 0;
          border: 1px solid #ccc;
          border-radius: 6px;
          font-size: 1rem;
          background: #fff;
          transition: border-color 0.2s, box-shadow 0.2s;
          box-sizing: border-box;
          outline: none;
      }

      .dues-check-content input:focus {
          border-color: #AF2630;
          box-shadow: 0 0 0 2px #f8d7da;
      }

      .dues-check-content button {
          background-color: #AF2630;
          color: white;
          border: none;
          padding: 12px 0;
          border-radius: 6px;
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          margin-top: 10px;
          width: 100%;
          transition: background 0.2s;
      }

      .dues-check-content button:hover {
          background-color: #8E1F27;
      }

      .dues-check-content .close-modal {
          position: absolute;
          top: 10px;
          right: 15px;
          font-size: 24px;
          cursor: pointer;
          color: #666;
      }

      .dues-check-content .error-message {
          color: #AF2630;
          margin-top: 10px;
          display: none;
          font-size: 0.98rem;
      }
  </style>
</head>
<body>
  <div class="top-bar">
      <button class="pay-dues-btn" onclick="openDuesCheck()">Pay your monthly dues here</button>
  </div>
  
  <div class="container">
      <div class="Welcome">
          <img src="../images/AvidaSettingsLogo.png" alt="Avida Settings Logo" onerror="this.onerror=null; this.src='/images/placeholder.png';">
      </div>

      <form id="loginForm">
          <div class="column">
              <div class="col-12">
                  <input type="text" class="rounded-input" placeholder="Enter Email" id="login" name="login" required>
              </div>
          </div>
          <div class="column">
              <div class="col-12 password-container">
                  <input type="password" class="rounded-input" placeholder="Enter Password" id="password" name="password" required>
                  <button type="button" class="password-toggle" id="togglePassword" aria-label="Toggle password visibility">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="eye-icon">
                          <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                          <circle cx="12" cy="12" r="3"></circle>
                      </svg>
                  </button>
              </div>
          </div>
          <div class="Loginbutton">
              <button type="submit" class="Login">Login</button>
          </div>
          <div class="dashboard-link">
            <a href="/Webpages/homeowner-dashboard.html">Homeowner Dashboard</a>
          </div>
      </form>
      <div id="errorMessage" style="color: #AF2630; margin-top: 10px; display: none;"></div>
  </div>

  <!-- Delinquent Account Modal -->
  <div id="delinquentModal" class="delinquent-modal">
      <div class="delinquent-content">
          <span id="closeDelinquentModal" class="close-modal">&times;</span>
          <h2>Account Delinquent</h2>
          <p>Your account has outstanding monthly dues that need to be paid before you can access the system.</p>
          <p>Outstanding Amount:</p>
          <div class="amount" id="delinquentAmount">₱0.00</div>
          <p>Please settle your dues to regain access to all features.</p>
          <button id="payNowBtn" class="pay-now-btn">Pay Now</button>
      </div>
  </div>

  <div id="customAlert" class="custom-alert">
      <div class="custom-alert-content">
          <div class="custom-alert-header">Notice</div>
          <div class="custom-alert-body">
              <p id="customAlertMessage"></p>
              <button onclick="closeCustomAlert()">OK</button>
          </div>
      </div>
  </div>

  <!-- Debug panel -->
  <div id="debug-panel">
      <pre id="debug-log"></pre>
  </div>
  <button id="debug-toggle" onclick="toggleDebug()">D</button>

  <!-- Add the dues check modal -->
  <div id="duesCheckModal" class="dues-check-modal">
      <div class="dues-check-content">
          <span class="close-modal" onclick="closeDuesCheck()">&times;</span>
          <h2>Check Monthly Dues</h2>
          <p>Please enter your login credentials to check your dues status</p>
          <input type="email" id="duesEmail" placeholder="Enter your email" required>
          <input type="password" id="duesPassword" placeholder="Enter your password" required>
          <button onclick="checkDuesStatus()">Check Status</button>
          <div id="duesErrorMessage" class="error-message"></div>
      </div>
  </div>

  <script>
    // Debug functions
    function toggleDebug() {
        const panel = document.getElementById('debug-panel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
    
    function debugLog(message) {
        console.log(message);
        const logElement = document.getElementById('debug-log');
        if (logElement) {
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
    }
    
    document.addEventListener("DOMContentLoaded", () => {
        debugLog("Page loaded");
        
        // Password visibility toggle
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');
        
        togglePassword.addEventListener('click', function() {
            debugLog("Password visibility toggled");
            
            // Toggle the type attribute
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            
            // Toggle the eye icon
            const eyeIcon = this.querySelector('.eye-icon');
            if (type === 'password') {
                // Show the "eye" icon (password is hidden)
                eyeIcon.innerHTML = `
                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                `;
            } else {
                // Show the "eye-off" icon (password is visible)
                eyeIcon.innerHTML = `
                    <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path>
                    <path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path>
                    <path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path>
                    <line x1="2" x2="22" y1="2" y2="22"></line>
                `;
            }
        });
        
        // Check if user is already logged in
        checkAlreadyLoggedIn();
        
        const loginForm = document.getElementById("loginForm");
        const errorMessage = document.getElementById("errorMessage");
        const delinquentModal = document.getElementById("delinquentModal");
        
        // Handle login form submission
        loginForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            try {
                const formData = new FormData(this);
                const email = formData.get('login');
                const password = formData.get('password');
                
                debugLog(`Attempting login with email: ${email}`);
                
                // Show loading indicator
                errorMessage.textContent = "Logging in...";
                errorMessage.style.display = "block";
                errorMessage.style.color = "#333";
                
                // First check if user is delinquent
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        login: email,
                        password: password
                    }),
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                
                const data = await response.json();
                debugLog(`Login response: ${JSON.stringify(data)}`);
                
                if (data.success) {
                    // Store user info in localStorage
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('email', data.email);
                    
                    errorMessage.textContent = "Login successful! Redirecting...";
                    errorMessage.style.color = "green";
                    
                    // Redirect based on role
                    window.location.href = data.redirectUrl;
                } else if (data.isDelinquent) {
                    debugLog("User is delinquent, showing modal");
                    
                    // Store delinquent user info for the payment page
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('email', email);
                    localStorage.setItem('dueAmount', data.dueAmount || "5000.00");
                    
                    // Show delinquent modal
                    document.getElementById('delinquentAmount').textContent = `₱${data.dueAmount || "5000.00"}`;
                    document.getElementById('delinquentModal').style.display = 'block';
                } else {
                    // Regular login failure
                    errorMessage.textContent = data.message || 'Invalid credentials';
                    errorMessage.style.color = "#AF2630";
                    errorMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                debugLog(`Login error: ${error.message}`);
                document.getElementById('errorMessage').textContent = 'An error occurred. Please try again.';
                document.getElementById('errorMessage').style.color = "#AF2630";
                document.getElementById('errorMessage').style.display = 'block';
            }
        });
        
        // Handle "Pay Now" button click
        document.getElementById("payNowBtn").addEventListener("click", () => {
            debugLog("Pay Now button clicked");
            
            // Get the due amount from the modal
            const dueAmount = document.getElementById("delinquentAmount").textContent.replace("₱", "");
            
            // Store the due amount in localStorage for the payment page
            localStorage.setItem("dueAmount", dueAmount);
            
            // Redirect to MDPayment.html
            debugLog("Redirecting to Webpages/MDPayment.html");
            window.location.href = "Webpages/MDPayment.html";
        });
        
        // Close delinquent modal when clicking the X
        document.getElementById("closeDelinquentModal").addEventListener("click", () => {
            delinquentModal.style.display = "none";
        });
    });
    
    // Function to check if user is already logged in
    async function checkAlreadyLoggedIn() {
        try {
            debugLog("Checking if user is already logged in");
            const response = await fetch("/api/check-auth", {
                method: "GET",
                credentials: "include",
                headers: {
                    Accept: "application/json",
                    "Cache-Control": "no-cache",
                },
            });
            
            if (!response.ok) {
                debugLog(`Auth check failed: ${response.status}`);
                return false;
            }
            
            const data = await response.json();
            debugLog(`Auth check response: ${JSON.stringify(data)}`);
            
            if (data.authenticated) {
                // User is already logged in, redirect to appropriate page
                const redirectUrl = data.user.role === "admin" ? "/Webpages/AdHome.html" : "/Webpages/HoHome.html";
                debugLog(`User already logged in, redirecting to ${redirectUrl}`);
                window.location.href = redirectUrl;
                return true;
            }
            
            return false;
        } catch (error) {
            debugLog(`Error checking login status: ${error.message}`);
            return false;
        }
    }
    
    function closeCustomAlert() {
        document.getElementById('customAlert').style.display = 'none';
    }
    
    function showCustomAlert(message) {
        const alertElement = document.getElementById('customAlert');
        const messageElement = document.getElementById('customAlertMessage');
        if (alertElement && messageElement) {
            messageElement.textContent = message;
            alertElement.style.display = 'block';
        }
    }
    
    // Check session status on page load and periodically
    checkSessionStatus();
    setInterval(checkSessionStatus, 5000);
    
    // Update the checkSessionStatus function to handle undefined error
    function checkSessionStatus() {
        try {
            fetch("/api/check-auth", {
                method: "GET",
                credentials: "include",
                headers: {
                    Accept: "application/json",
                    "Cache-Control": "no-cache",
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Update session info if available
                const sessionInfo = document.getElementById("session-info");
                if (sessionInfo) {
                    if (data.authenticated) {
                        sessionInfo.textContent = `Logged in as: ${data.user.email} (${data.user.role})`;
                        sessionInfo.style.display = "block";
                    } else {
                        sessionInfo.style.display = "none";
                    }
                }
            })
            .catch(error => {
                console.error("Error checking session:", error);
            });
        } catch (error) {
            console.error("Error in checkSessionStatus:", error);
        }
    }

    // Add these new functions for dues checking
    function openDuesCheck() {
        document.getElementById('duesCheckModal').style.display = 'block';
    }

    function closeDuesCheck() {
        document.getElementById('duesCheckModal').style.display = 'none';
        document.getElementById('duesErrorMessage').style.display = 'none';
        document.getElementById('duesEmail').value = '';
        document.getElementById('duesPassword').value = '';
    }

    async function checkDuesStatus() {
        const email = document.getElementById('duesEmail').value;
        const password = document.getElementById('duesPassword').value;
        const errorMessage = document.getElementById('duesErrorMessage');
        
        if (!email || !password) {
            errorMessage.textContent = 'Please enter both email and password';
            errorMessage.style.display = 'block';
            return;
        }
        
        try {
            // First verify credentials
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    login: email,
                    password: password
                }),
                credentials: 'include'
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Check if user has unpaid dues
                const duesResponse = await fetch('/api/check-dues-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email
                    })
                });
                
                const duesData = await duesResponse.json();
                
                if (duesData.hasUnpaidDues) {
                    // Store user info and redirect to payment page
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('email', email);
                    localStorage.setItem('dueAmount', duesData.dueAmount || "5000.00");
                    window.location.href = 'MDPayment.html';
                } else {
                    errorMessage.textContent = 'You have no unpaid dues for this month';
                    errorMessage.style.display = 'block';
                }
            } else if (data.isDelinquent) {
                // User is delinquent, redirect to payment page
                localStorage.setItem('username', data.username);
                localStorage.setItem('email', data.email);
                localStorage.setItem('dueAmount', data.dueAmount || "5000.00");
                window.location.href = 'MDPayment.html';
            } else {
                errorMessage.textContent = 'Invalid credentials';
                errorMessage.style.display = 'block';
            }
        } catch (error) {
            console.error('Error checking dues status:', error);
            errorMessage.textContent = 'An error occurred. Please try again.';
            errorMessage.style.display = 'block';
        }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('duesCheckModal');
        if (event.target === modal) {
            closeDuesCheck();
        }
    }
  </script>
</body>
</html>
