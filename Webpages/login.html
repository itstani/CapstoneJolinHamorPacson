<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login Form</title>
  <style>
      body {
          padding-top: 60px;
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          margin: 0;
          background-color: #f8f8f8;
      }

      .top-bar {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 60px;
          background-color: #AF2630;
          z-index: 1000;
      }

      .container {
          margin-top: 20px;
          display: flex;
          flex-direction: column;
          align-items: center;
      }

      .column {
          margin-bottom: 20px;
      }

      .col-12 {
          width: 100%; 
          text-align: center;
      }

      .Welcome img {
          width: 700px;
          height: 250px;
          margin-bottom: 20px;
      }

      .rounded-input {
          border-radius: 20px;
          border: 2px solid #ccc;
          padding: 20px;
          width: 300px;
          font-size: 25px;
          font-weight: 600;
          font-family: 'inter';
          text-align: center;
          margin-bottom: 15px;
      }

      .Loginbutton {
          text-align: center;
          margin-top: 20px;
      }

      .Login {
          padding: 20px;
          width: 200px;
          font-size: 25px;
          font-family: 'inter';
          border-radius: 20px;
          border: 2px solid #ccc;
          color: white;
          background-color: #AF2630;
          cursor: pointer;
          font-weight: bold;
      }
      .fbbutton, .gbutton{
          background-color: transparent;
          border: none;
          cursor: pointer;
      }

      .fbbutton img{
          width: 50px;
          height: 50px;
          
      }
      .gbutton img{
          width: 50px;
          height: 50px;
          
      }
      
      .altLogin{
          font-size: 20px;
          font-family: 'inter';
          text-align: center;
      }
      .regis-here {
          font-size: 20px;
          font-family: 'inter';
          margin-top: 15px;
          cursor: pointer;
          color: #AF2630;
          text-decoration: underline;
          padding-left: 5px;
          text-align: center;
      }
      .fpw {
          font-size: 20px;
          font-family: 'inter';
          margin-top: 15px;
          cursor: pointer;
          color: #AF2630;
          text-decoration: underline;
          padding-left: 5px;
          text-align: center;
      }
      .custom-alert {
          display: none;
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background-color: white;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
          z-index: 1001;
      }

      .custom-alert-content {
          text-align: center;
      }

      .custom-alert-header {
          font-size: 18px;
          font-weight: bold;
          margin-bottom: 10px;
          color: #AF2630;
      }

      .custom-alert-body {
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 10px;
      }

      .custom-alert button {
          background-color: #AF2630;
          color: white;
          border: none;
          padding: 8px 15px;
          border-radius: 5px;
          cursor: pointer;
      }
      
      /* Delinquent Modal Styles */
      .delinquent-modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 9999;
      }

      .delinquent-content {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background-color: #fff;
          padding: 30px;
          border-radius: 10px;
          width: 80%;
          max-width: 500px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
          text-align: center;
      }

      .close-modal {
          position: absolute;
          top: 10px;
          right: 15px;
          font-size: 24px;
          font-weight: bold;
          color: #333;
          cursor: pointer;
      }

      .delinquent-content h2 {
          font-size: 24px;
          margin-bottom: 15px;
          color: #AF2630;
      }

      .delinquent-content p {
          font-size: 16px;
          margin: 10px 0;
          line-height: 1.5;
      }

      .delinquent-content .amount {
          font-size: 22px;
          font-weight: bold;
          color: #AF2630;
          margin: 15px 0;
      }

      .pay-now-btn {
          background-color: #AF2630;
          color: white;
          border: none;
          padding: 12px 25px;
          border-radius: 5px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          margin-top: 15px;
          transition: background-color 0.3s;
      }

      .pay-now-btn:hover {
          background-color: #8f1d25;
      }
      
      /* Debug panel styles */
      #debug-panel {
          display: none;
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background-color: rgba(0, 0, 0, 0.8);
          color: #00ff00;
          font-family: monospace;
          padding: 10px;
          max-height: 200px;
          overflow-y: auto;
          z-index: 9999;
      }
      
      #debug-panel pre {
          margin: 0;
          white-space: pre-wrap;
      }
      
      #debug-toggle {
          position: fixed;
          bottom: 10px;
          right: 10px;
          background-color: #333;
          color: white;
          border: none;
          border-radius: 50%;
          width: 30px;
          height: 30px;
          font-size: 16px;
          cursor: pointer;
          z-index: 10000;
      }
      
      /* Emergency login button */
      #emergency-login {
          position: fixed;
          bottom: 10px;
          left: 10px;
          background-color: #AF2630;
          color: white;
          border: none;
          border-radius: 5px;
          padding: 8px 15px;
          font-size: 14px;
          cursor: pointer;
          z-index: 10000;
          display: none;
      }
      
      /* Session info panel */
      #session-info {
          position: fixed;
          top: 70px;
          right: 10px;
          background-color: rgba(0, 0, 0, 0.7);
          color: #00ff00;
          padding: 10px;
          border-radius: 5px;
          font-family: monospace;
          font-size: 12px;
          max-width: 300px;
          z-index: 9999;
          display: none;
      }
  </style>
  <script>
    
document.addEventListener("DOMContentLoaded", () => {
  // Check if user is already logged in
  checkAlreadyLoggedIn();

  // Handle login form submission
  document.addEventListener("DOMContentLoaded", () => {
      // Handle login form submission
      document.getElementById('loginForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        try {
          const login = document.getElementById('login').value;
          const password = document.getElementById('password').value;
          
          // Show loading indicator
          const errorMessage = document.getElementById('errorMessage');
          errorMessage.textContent = "Logging in...";
          errorMessage.style.display = "block";
          errorMessage.style.color = "#333";
          
          // Send login request to server
          const response = await fetch('/api/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              login: login,
              password: password
            }),
            credentials: 'include'
          });
          
          const data = await response.json();
          console.log("Login response:", data); // Debug log
          
          if (data.success) {
            // Store user info in localStorage
            localStorage.setItem('username', data.username);
            localStorage.setItem('email', data.email);
            
            errorMessage.textContent = "Login successful! Redirecting...";
            errorMessage.style.color = "green";
            
            // Redirect based on role
            window.location.href = data.redirectUrl;
          } else if (data.isDelinquent) {
            // User is delinquent - store info in sessionStorage
            sessionStorage.setItem('isDelinquent', 'true');
            sessionStorage.setItem('delinquentUsername', data.username);
            sessionStorage.setItem('delinquentEmail', data.email);
            sessionStorage.setItem('dueAmount', data.dueAmount);
            
            // Also store in localStorage as a backup
            localStorage.setItem('delinquentUser', 'true');
            localStorage.setItem('delinquentUsername', data.username);
            localStorage.setItem('delinquentEmail', data.email);
            localStorage.setItem('dueAmount', data.dueAmount);
            
            console.log("User is delinquent, redirecting to payment page");
            
            // Redirect directly to payment page
            window.location.href = '/Webpages/MDPayment.html';
          } else {
            // Regular login failure
            errorMessage.textContent = data.message || 'Invalid credentials';
            errorMessage.style.color = "#AF2630";
            errorMessage.style.display = 'block';
          }
        } catch (error) {
          console.error('Login error:', error);
          document.getElementById('errorMessage').textContent = 'An error occurred. Please try again.';
          document.getElementById('errorMessage').style.color = "#AF2630";
          document.getElementById('errorMessage').style.display = 'block';
        }
      });
      
      // Close delinquent modal when clicking the X
      const closeModalBtn = document.getElementById("closeDelinquentModal");
      if (closeModalBtn) {
        closeModalBtn.addEventListener("click", () => {
          document.getElementById("delinquentModal").style.display = "none";
        });
      }
    });

  
  // Handle "Pay Now" button click - Make sure this is working correctly
  document.getElementById('payNowBtn').addEventListener('click', function() {
          console.log("Pay Now button clicked, redirecting to MDPayment.html");
          
          // Add debugging information
          const debugInfo = {
            currentLocation: window.location.href,
            targetLocation: './MDPayment.html',
            timestamp: new Date().toISOString()
          };
          console.log("Debug info:", debugInfo);
          
          // Try both approaches to redirect
          try {
            window.location.href = './MDPayment.html';
            // As a fallback, try after a short delay
            setTimeout(() => {
              window.location.replace('./MDPayment.html');
            }, 100);
          } catch (error) {
            console.error("Error during redirect:", error);
          }
        });

  // Close delinquent modal when clicking the X
  document.getElementById("closeDelinquentModal").addEventListener("click", () => {
    document.getElementById("delinquentModal").style.display = "none";
  });
});

// Function to check if user is already logged in
async function checkAlreadyLoggedIn() {
  try {
    const response = await fetch("/api/check-auth", {
      method: "GET",
      credentials: "include",
      headers: {
        Accept: "application/json",
        "Cache-Control": "no-cache",
      },
    });

    if (!response.ok) {
      return false;
    }

    const data = await response.json();

    if (data.authenticated) {
      // User is already logged in, redirect to appropriate page
      const redirectUrl = data.user.role === "admin" ? "/Webpages/AdHome.html" : "/Webpages/HoHome.html";
      console.log(`User already logged in, redirecting to ${redirectUrl}`);
      window.location.href = redirectUrl;
      return true;
    }

    return false;
  } catch (error) {
    console.error(`Error checking login status: ${error.message}`);
    return false;
  }
}

function closeCustomAlert() {
      document.getElementById('customAlert').style.display = 'none';
    }
  

function showCustomAlert(message) {
  const alertElement = document.getElementById('customAlert');
  const messageElement = document.getElementById('customAlertMessage');
  if (alertElement && messageElement) {
      messageElement.textContent = message;
      alertElement.style.display = 'block';
  }
}

// Check session status on page load and periodically
checkSessionStatus();
setInterval(checkSessionStatus, 5000);

// Update the checkSessionStatus function to handle undefined error
function checkSessionStatus() {
  try {
    fetch("/api/check-auth", {
      method: "GET",
      credentials: "include",
      headers: {
        Accept: "application/json",
        "Cache-Control": "no-cache",
      },
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      // Update session info if available
      const sessionInfo = document.getElementById("session-info");
      if (sessionInfo) {
        if (data.authenticated) {
          sessionInfo.textContent = `Logged in as: ${data.user.email} (${data.user.role})`;
          sessionInfo.style.display = "block";
        } else {
          sessionInfo.style.display = "none";
        }
      }
    })
    .catch(error => {
      console.error("Error checking session:", error);
    });
  } catch (error) {
    console.error("Error in checkSessionStatus:", error);
  }
}

document.getElementById("payNowBtn").addEventListener("click", () => {
  console.log("Pay Now button clicked")

  // Store delinquent info in localStorage before redirect
  const delinquentUsername = document.getElementById("delinquentUsername").textContent
  const delinquentEmail = document.getElementById("delinquentEmail").textContent
  const dueAmount = document.getElementById("delinquentAmount").textContent

  localStorage.setItem("delinquentUser", "true")
  localStorage.setItem("delinquentUsername", delinquentUsername)
  localStorage.setItem("delinquentEmail", delinquentEmail)
  localStorage.setItem("dueAmount", dueAmount)

  // Use window.location.href for the redirect
  window.location.href = "/Webpages/MDPayment.html"
})


</script>
</head>
<body>
  <div class="top-bar"></div>
  
  <div class="container">
      <div class="Welcome">
          <img src="../images/AvidaSettingsLogo.png" alt="Avida Settings Logo" onerror="this.onerror=null; this.src='/images/placeholder.png';">
      </div>

      <form id="loginForm">
          <div class="column">
              <div class="col-12">
                  <input type="text" class="rounded-input" placeholder="Enter Email" id="login" name="login" required>
              </div>
          </div>
          <div class="column">
              <div class="col-12">
                  <input type="password" class="rounded-input" placeholder="Enter Password" id="password" name="password" required>
              </div>
          </div>
          <div class="Loginbutton">
              <button type="submit" class="Login">Login</button>
          </div>
      </form>
      <div id="errorMessage" style="color: #AF2630; margin-top: 10px; display: none;"></div>
  </div>

  <!-- Delinquent Account Modal -->
  <div id="delinquentModal" class="delinquent-modal">
      <div class="delinquent-content">
          <span id="closeDelinquentModal" class="close-modal">&times;</span>
          <h2>Account Delinquent</h2>
          <p>Your account has outstanding monthly dues that need to be paid before you can access the system.</p>
          <p>Outstanding Amount:</p>
          <div class="amount" id="delinquentAmount">â‚±0.00</div>
          <p>Please settle your dues to regain access to all features.</p>
          <button id="payNowBtn" class="pay-now-btn">Pay Now</button>
      </div>
  </div>

  <div id="customAlert" class="custom-alert">
      <div class="custom-alert-content">
          <div class="custom-alert-header">Notice</div>
          <div class="custom-alert-body">
              <p id="customAlertMessage"></p>
              <button onclick="closeCustomAlert()">OK</button>
          </div>
      </div>
  </div>

</body>
</html>
