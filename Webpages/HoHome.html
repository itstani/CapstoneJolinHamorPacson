<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Dashboard</title>
    <link rel="stylesheet" type="text/css" href="/CSS/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <style>

      * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
      /* Reserve Section in Columns */
      .reserve {
        display: flex;
        justify-content: center; /* Centers content horizontally */
        gap: 20%; /* Space between the buttons */
        text-align: center;
        flex-wrap: wrap; /* Allows buttons to wrap on smaller screens */
      }
 
      .reservetext1 {
        font-size: 40px;
        font-family: "Inter";
        color: #3e0408;
        font-weight: bold;
        margin-top: 10px;
        text-align: center;
        width: 100%; /* Ensure the text takes up full width */
      }
 
      .reserve-item {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
 
      .reserve button {
        border: 2px solid #3e0408;
        background: transparent;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
 
      .reserve button:hover {
        background-color: #3e0408;
        color: #ffffff;
        transform: scale(1.1);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      }
 
      .reserve button img {
        width: 300px;
        height: 300px;
      }
 
      .reserve button:hover img {
        filter: brightness(1.2);
      }
 
      .reservetext,
      .raisetext {
        font-size: 20px;
        font-family: "Inter";
        color: #3e0408;
        font-weight: bold;
        margin-top: 10px;
        padding-top: 20px;
      }
      .button {
      margin-top: auto;
      margin-bottom: 20px; /* Adjust this as needed */
      width: 100%;
      text-align: center;
 
 
    }
 
      /* Responsive adjustments for smaller screens */
      @media (max-width: 600px) {
        .search-bar {
          width: 100%;
        }
 
        .top-bar {
          padding: 0 10px;
        }
 
        .reserve {
          flex-direction: column; /* Stack buttons vertically on small screens */
          gap: 20px;
        }
 
        .reservetext1 {
          font-size: 30px; /* Adjust the size for smaller screens */
        }
      }
 
      .popup {
    display: none; /* Hidden by default */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1001;
    justify-content: center;
    align-items: center;
    font-family: sans-serif;
}

.popup-content {
    background-color: #ffffff; 
    color: #000000; 
    padding: 20px;
    border: 2px solid #af2630; 
    border-radius: 8px;
    width: 900px;
    height: auto;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    box-sizing: border-box;
    font-family: sans-serif;
    position: relative; 
}

.popup-top-bar {
    background-color: #af2630; 
    color: #ffffff; 
    padding: 10px;
    font-size: 24px;
    font-weight: bold;
    text-align: center;
    border-top-left-radius: 8px; 
    border-top-right-radius: 8px;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
}

.popup-content-inner {
    margin-top: 60px; 
}

.popup-content label {
    display: block;
    margin: 10px 0 5px;
    font-size: 20px;
    font-weight: bold;
}

.popup-content input[type="text"],
.popup-content textarea {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
    font-size: 20px;
}

.popup-content textarea {
    resize: none;
}

.popup-buttons {
    display: flex;
    align-items: center;
    justify-content: space-between; 
}


#closePopup {
    background-color: #fff;
    color: #af2630;
    border: 2px solid #af2630;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    font-size: 20px;
    transition: all 0.3s ease;
    margin-right: auto; 
}

#closePopup:hover {
    background-color: #d9d9d9;
    border-color: #d9d9d9;
}

#sendButton {
    background-color: #fff;
    color: #af2630;
    border: 2px solid #af2630;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    font-size: 20px;
    transition: all 0.3s ease;
}

#sendButton:hover {
    background-color: #d9d9d9;
    border-color: #d9d9d9;
}

.file-container {
  align-self: flex-end;  
  margin-top: 10px;
}
        
/* Notification Modal Styles */
.notification-container {
            position: relative;
            display: inline-block;
        }

.notification-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    width: 600px; /* Increased width */
    max-width: 90vw;
    max-height: 80vh; /* Reduced height */
    overflow: hidden;
    z-index: 1001;
}

.notification-icon {
    position: fixed;
    top: 7px;
    right: 16px;
    background: rgb(195, 67, 67);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
    z-index: 1002; /* Ensure it's above the header */
}


.notification-header {
    background-color: #AF2630;
    color: white;
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.notification-header h2 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
}

.close-modal {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    opacity: 0.8;
    transition: opacity 0.2s;
}

.close-modal:hover {
    opacity: 1;
}

.notification-list {
    max-height: calc(80vh - 140px);
    overflow-y: auto;
    padding: 16px;
}

.notification-item {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    display: flex;
    flex-direction: column; /* Stack content vertically */
    gap: 12px;
    align-items: flex-start;
    transition: transform 0.2s, box-shadow 0.2s;
}

.notification-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.notification-checkbox {
    margin-top: 4px;
    cursor: pointer;
}

.notification-content {
    flex: 1;
    min-width: 0; /* Allow text to wrap */
}

.notification-message {
    color: #2d3436;
    font-size: 0.95rem;
    margin-bottom: 8px;
    line-height: 1.4;
    word-wrap: break-word; /* Ensure long text wraps */
}

.notification-timestamp {
    color: #636e72;
    font-size: 0.85rem;
}

.proceed-to-payment-btn {
    background-color: #AF2630;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: background-color 0.2s;
    margin: 8px auto; /* Center the button */
    display: block; /* Make it a block element */
    width: fit-content; /* Width based on content */
}

.proceed-to-payment-btn:hover {
    background-color: #8f1d25;
}

.notification-actions {
    padding: 16px;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    border-top: 1px solid #e9ecef;
}

.clear-btn {
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
}

#clearSelectedBtn {
    background-color: white;
    color: #AF2630;
    border: 1px solid #AF2630;
}

#clearAllBtn {
    background-color: #AF2630;
    color: white;
    border: 1px solid #AF2630;
}

.clear-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

.no-notifications {
    text-align: center;
    padding: 32px 16px;
    color: #636e72;
    font-size: 0.95rem;
}

/* Notification Icon Styles */


.notification-icon:hover {
    transform: scale(1.05);
}

.notification-icon img {
    width: 24px;
    height: 24px;
}

.notification-count {
    position: absolute;
    top: -6px;
    right: -6px;
    background-color: #AF2630;
    color: white;
    border-radius: 12px;
    padding: 2px 6px;
    font-size: 0.75rem;
    font-weight: 600;
    min-width: 20px;
    text-align: center;
}

.notification-modal.show {
    display: block;
    animation: slideIn 0.3s ease forwards;
}


        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }

        .close-modal:hover {
            opacity: 0.8;
        }

        .logoutbutton{
            margin-top: auto;
            margin-bottom: 30px; /* Adjust this as needed */
            width: 100%;
            text-align: center;
        }

        /* Mobile CSS*/
        @media (max-width: 768px) {
    .notification-modal {
        width: 95vw;
        max-height: 80vh;
    }

    .notification-list {
        max-height: calc(80vh - 140px);
    }

    .notification-item {
        padding: 12px;
    }

    .notification-actions {
        padding: 12px;
    }

    .clear-btn {
        padding: 8px 12px;
        font-size: 0.85rem;
    }
}

        /* Animation */
@keyframes slideIn {
    from {
        transform: translate(-50%, -60%);
        opacity: 0;
    }
    to {
        transform: translate(-50%, -50%);
        opacity: 1;
    }
}
        @media screen and (max-width: 768px) {
            /* Sidebar becomes bottom navigation */
            .side-bar {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 70px;
                padding: 0;
                display: flex;
                justify-content: space-around;
                align-items: center;
                background-color: #D9D9D9;
                z-index: 1000;
            }

            .Home, .Calendar, .Profile {
                margin: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .Home img, .Calendar img, .Profile img {
                width: 30px;
                height: 30px;
            }

            .Home p, .Calendar p, .Profile p {
                margin-top: 4px;
                font-size: 12px;
            }

            /* Welcome section adjustments */
            

            /* Reserve section adjustments */
            .reserve {
                padding: 20px;
                margin-bottom: 80px;
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }

            .reservetext1 {
                font-size: 24px;
                margin-bottom: 20px;
            }

            .reserve-item {
                width: 100%;
                max-width: 300px;
            }

            .reserve button img {
                width: 200px;
                height: 200px;
            }

            /* Popup improvements */
            .popup-content {
                width: 95%;
                max-width: 400px;
                margin: 10px;
                height: auto;
                max-height: 90vh;
            }

            .popup-content-inner {
                margin-top: 50px;
                padding: 10px;
            }

            /* Form inputs */
            .popup-content input[type="text"],
            .popup-content textarea {
                font-size: 16px;
                padding: 12px;
            }

            /* Notification adjustments */
            .notification-icon {
                top: 10px;
                right: 10px;
            }

            .notification-modal {
                width: 95%;
                height: auto;
                max-height: 90vh;
                margin: 10px;
            }

            .notification-item {
                padding: 12px;
                flex-direction: column;
            }

            /* Button improvements */
            .button {
                position: fixed;
                bottom: 70px;
                left: 0;
                width: 100%;
                background-color: #D9D9D9;
                padding: 10px;
                margin: 0;
                text-align: center;
                z-index: 999;
            }

            /* Improve touch targets */
            button,
            input[type="button"],
            input[type="submit"] {
                min-height: 44px;
                min-width: 44px;
                padding: 12px;
            }
        }

        /* Tablet improvements */
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            .reserve button img {
                width: 250px;
                height: 250px;
            }

            .Welcome {
                margin-left: 90px;
            }

            .form-image-container {
                margin-left: 90px;
            }
        }

        /* Touch device improvements */
        @media (hover: none) {
            .reserve button:hover {
                transform: none;
            }

            .reserve button:active {
                background-color: rgba(62, 4, 8, 0.1);
            }
        }
    </style>
  </head>
  <body>
    <div class="notification-icon" id="notificationIcon">
        <img src="/images/bell.png" alt="Notifications" onerror="handleImageError(this)" />
        <span class="notification-count" id="notificationCount">0</span>
      </div>
    
    <div class="top-bar"></div>
    
    <div class="side-bar">
        <div class="Home">
            <button type="button" id="homebutton" name="homebutton" aria-label="home" onclick="window.location.href='HoHome.html'">
                <img src="/images/house.png" alt="Home" onerror="handleImageError(this)" />
            </button>
            <p>Home</p>
        </div>
        
        <div class="Calendar">
            <button type="button" id="calendarbutton" name="calendarbutton" aria-label="calendar" onclick="window.location.href='calender.html'">
                <img src="/images/Calendar.png" alt="Calendar" onerror="handleImageError(this)" />
            </button>
            <p>Calendar</p>
        </div>
        
        <div class="Profile">
          <button type="button" id="profilebutton" name="profilebutton" aria-label="profile" onclick="window.location.href='profile.html'">
              <img src="/images/profileicon.png" alt="Profile" onerror="handleImageError(this)" />
          </button>
          <p>Profile</p>
      </div>
      
      <div class="logoutbutton">
          <button type="button" id="logoutButton">Logout</button>
          <p>Logout</p>
      </div>
  </div>
    
  <div class="Welcome">
    <h1>Welcome home!</h1>
    <img src="/images/AvidaSettingsLogo.png" alt="Avida Settings Logo" class="avidalogo" onerror="handleImageError(this)" />
  </div>

  <div class="reserve">
    <p class="reservetext1">What would you like to do?</p>
    
    <div class="reserve-item">
        <button type="button" class="poolbutton" id="poolbutton" name="poolbutton" aria-label="pool" onclick="window.location.href='addevent.html'">
            <img src="/images/pool.png" alt="Pool" onerror="handleImageError(this)" />
        </button>
        <p class="reservetext">Reserve for an Outing or an event?</p>
    </div>
    
    <div class="reserve-item">
        <button type="button" class="adminbutton" id="adminbutton" name="adminbutton" aria-label="admin">
            <img src="/images/Admin.png" alt="Admin" onerror="handleImageError(this)" />
        </button>
        <p class="raisetext">Raise your concern to an admin</p>
    </div>
  </div>
 
    <div id="adminPopup" class="popup">
      <div class="popup-content">
          <div class="popup-top-bar">Raise a Concern</div>
          <div class="popup-content-inner">
              
              <form id="adminForm">
                  <label for="subject">Subject</label>
                  <input type="text" id="subject" name="subject" placeholder="Enter subject" required />
  
                  <label for="message">Message</label>
                
                  <textarea id="message" name="message" placeholder="Enter your message" rows="5" required></textarea>
  
                 

                  <div class="popup-buttons">
                      <button type="button" id="closePopup">Cancel</button>
                      
                      <form action="/upload" method="POST" enctype="multipart/form-data">
                        
                        <input type="file" id="fileInput" name="file" accept="image/*,application/pdf" />

                        <button type="submit" id="sendButton">Send</button>
                      </form>
                  </div>
              </form>
          </div>
      </div>
  </div>
  
  <div class="notification-modal" id="notificationModal">
    <span class="close-modal" id="closeModal">&times;</span>
    <div class="notification-header">
        <h2>Notifications</h2>
    </div>
    <div class="notification-list" id="notificationList"></div>
    <div class="notification-actions">
      <button id="clearSelectedBtn" class="clear-btn">Clear Selected</button>
      <button id="clearAllBtn" class="clear-btn">Clear All</button>
    </div>
  </div>
  </body>
  <script>
let notifications = [];
const MAX_RETRIES = 3;
const RETRY_DELAY = 2000;
let retryCount = 0;

// Function to update the notification list in the UI - defined first since it's used by multiple functions
function updateNotificationList() {
  console.log("Updating notification list");
  const notificationList = document.getElementById('notificationList');
  if (!notificationList) {
    console.error('Notification list element not found');
    return;
  }
  
  notificationList.innerHTML = ''; // Clear existing list

  if (!notifications || notifications.length === 0) {
    const noNotifications = document.createElement('div');
    noNotifications.classList.add('no-notifications');
    noNotifications.textContent = 'No new notifications';
    notificationList.appendChild(noNotifications);
    return;
  }

  notifications.forEach((notification) => {
    const notificationItem = document.createElement('div');
    notificationItem.classList.add('notification-item');

    // Create checkbox
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'notification-checkbox';
    checkbox.dataset.id = notification._id;

    // Create content wrapper
    const contentWrapper = document.createElement('div');
    contentWrapper.className = 'notification-content';

    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = 'notification-message';
    messageDiv.textContent = notification.message;

    // Create timestamp element
    const timestampDiv = document.createElement('div');
    timestampDiv.className = 'notification-timestamp';
    timestampDiv.textContent = new Date(notification.timestamp).toLocaleString();

    // Add message and timestamp to content wrapper
    contentWrapper.appendChild(messageDiv);
    contentWrapper.appendChild(timestampDiv);

    // Add elements to notification item
    notificationItem.appendChild(checkbox);
    notificationItem.appendChild(contentWrapper);

    // If it's an event notification that requires payment, add the proceed button
    if (notification.type === 'event_deleted' || notification.type === 'payment_required') {
      const proceedButton = document.createElement('button');
      proceedButton.className = 'proceed-to-payment-btn';
      proceedButton.textContent = 'Proceed to Payment';
      proceedButton.onclick = () => proceedToPayment(notification);
      notificationItem.appendChild(proceedButton);
    }

    notificationList.appendChild(notificationItem);
  });
}

// Function to update the clear buttons state
function updateClearButtons() {
  console.log("Updating clear buttons");
  const clearSelectedBtn = document.getElementById('clearSelectedBtn');
  const clearAllBtn = document.getElementById('clearAllBtn');
  
  if (!clearSelectedBtn || !clearAllBtn) {
    console.error('Clear buttons not found');
    return; // Buttons not found
  }
  
  if (notifications.length === 0) {
    clearSelectedBtn.disabled = true;
    clearAllBtn.disabled = true;
    clearSelectedBtn.style.opacity = '0.5';
    clearAllBtn.style.opacity = '0.5';
  } else {
    clearSelectedBtn.disabled = false;
    clearAllBtn.disabled = false;
    clearSelectedBtn.style.opacity = '1';
    clearAllBtn.style.opacity = '1';
  }
}

// Function to handle when there are no notifications
function handleNoNotifications() {
  console.log("Handling no notifications");
  notifications = [];
  const notificationCountElement = document.getElementById('notificationCount');
  if (notificationCountElement) {
    notificationCountElement.textContent = '0';
  }
  updateNotificationList();
  updateClearButtons();
}

// Function to show error messages
function showErrorMessage(message) {
  console.error('Error message:', message);
  const errorDiv = document.createElement('div');
  errorDiv.textContent = message;
  errorDiv.style.color = 'red';
  errorDiv.style.padding = '10px';
  errorDiv.style.marginTop = '10px';
  errorDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.1)';
  errorDiv.style.border = '1px solid red';
  errorDiv.style.borderRadius = '5px';
  
  // Find a good place to add the error message
  const notificationList = document.getElementById('notificationList');
  if (notificationList) {
    notificationList.prepend(errorDiv);
  } else {
    document.body.appendChild(errorDiv);
  }
  
  setTimeout(() => {
    if (errorDiv.parentNode) {
      errorDiv.parentNode.removeChild(errorDiv);
    }
  }, 5000); // Remove after 5 seconds
}

// Function to proceed to payment
function proceedToPayment(notification) {
  console.log("Proceeding to payment", notification);
  // Check if notification has a relatedId
  if (!notification.relatedId) {
    alert('Error: Missing event ID. Please contact support.');
    return;
  }
  
  const eventId = notification.relatedId;
  console.log("Proceeding to payment for event ID:", eventId);
  console.log("Full notification object:", JSON.stringify(notification));
  
  // Show loading indicator
  const loadingDiv = document.createElement('div');
  loadingDiv.textContent = 'Loading event details...';
  loadingDiv.style.position = 'fixed';
  loadingDiv.style.top = '50%';
  loadingDiv.style.left = '50%';
  loadingDiv.style.transform = 'translate(-50%, -50%)';
  loadingDiv.style.padding = '20px';
  loadingDiv.style.background = 'white';
  loadingDiv.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
  loadingDiv.style.borderRadius = '5px';
  loadingDiv.style.zIndex = '9999';
  document.body.appendChild(loadingDiv);
  
  // First try to fetch the event by ID
  fetch(`/api/event/${eventId}`)
    .then(response => {
      if (!response.ok) {
        // If that fails, try to get events by user email
        if (notification.userEmail) {
          console.log("Event not found by ID, trying by user email:", notification.userEmail);
          return fetch(`/api/user-events/${encodeURIComponent(notification.userEmail)}`);
        }
        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        let eventData;
        
        // Handle response from either endpoint
        if (data.event) {
          // Response from /api/event/:eventId
          eventData = data.event;
        } else if (data.events && data.events.length > 0) {
          // Response from /api/user-events/:userEmail
          // Use the most recent event
          eventData = data.events[0];
        } else {
          throw new Error("No event data found");
        }
        
        console.log("Event data to use:", eventData);
        
        // Store the event data in sessionStorage
        sessionStorage.setItem('eventData', JSON.stringify(eventData));
        
        // Remove loading indicator
        document.body.removeChild(loadingDiv);
        
        // Redirect to the payment page
        window.location.href = 'payment.html';
      } else {
        throw new Error(data.message || "Unknown error");
      }
    })
    .catch(error => {
      console.error('Error fetching event details:', error);
      
      // Remove loading indicator
      if (document.body.contains(loadingDiv)) {
        document.body.removeChild(loadingDiv);
      }
      
      // Offer manual entry as a fallback
      const useManualEntry = confirm(
        'Failed to fetch event details automatically. Would you like to enter event details manually?\n\n' +
        'Error: ' + error.message
      );
      
      if (useManualEntry) {
        // Create a minimal event object with data from the notification
        const minimalEvent = {
          userEmail: notification.userEmail || '',
          eventName: notification.eventName || 'Unknown Event',
          eventDate: notification.eventDate || new Date().toISOString().split('T')[0],
          startTime: notification.startTime || '09:00',
          endTime: notification.endTime || '12:00',
          amenity: notification.amenity || 'Unknown',
        };
        
        sessionStorage.setItem('eventData', JSON.stringify(minimalEvent));
        window.location.href = 'payment.html';
      }
    });
}

// Function to clear selected notifications
async function clearSelectedNotifications() {
  console.log("Clearing selected notifications");
  const selectedIds = Array.from(document.querySelectorAll('.notification-checkbox:checked'))
    .map(checkbox => checkbox.dataset.id);

  if (selectedIds.length === 0) {
    alert('No notifications selected');
    return;
  }

  try {
    const response = await fetch('/api/markNotificationsAsRead', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ notificationIds: selectedIds }),
      credentials: 'include'
    });

    if (response.ok) {
      const result = await response.json();
      if (result.success) {
        notifications = notifications.filter(n => !selectedIds.includes(n._id));
        const notificationCount = document.getElementById('notificationCount');
        if (notificationCount) {
          notificationCount.textContent = notifications.length;
        }
        updateNotificationList();
        updateClearButtons();
      }
    }
  } catch (error) {
    console.error('Error clearing selected notifications:', error);
    showErrorMessage('Failed to clear notifications. Please try again.');
  }
}

// Function to clear all notifications
async function clearAllNotifications() {
  console.log("Clearing all notifications");
  try {
    const response = await fetch('/api/clearAllNotifications', {
      method: 'POST',
      credentials: 'include'
    });

    if (response.ok) {
      const result = await response.json();
      if (result.success) {
        notifications = [];
        const notificationCount = document.getElementById('notificationCount');
        if (notificationCount) {
          notificationCount.textContent = '0';
        }
        updateNotificationList();
        updateClearButtons();
      }
    }
  } catch (error) {
    console.error('Error clearing all notifications:', error);
    showErrorMessage('Failed to clear notifications. Please try again.');
  }
}

// Function to fetch notifications from the server - defined last since it uses all the above functions
async function fetchNotifications() {
  console.log("Fetching notifications");
  try {
    console.log("Attempting to fetch notifications...");
    const response = await fetch('/api/notifications', {
      method: 'GET',
      credentials: 'include',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    });

    console.log("Fetch response received:", response);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const responseText = await response.text();
    console.log("Response text:", responseText);

    let data;
    try {
      data = JSON.parse(responseText);
    } catch (parseError) {
      console.error("Error parsing JSON:", parseError);
      throw new Error("Invalid JSON response");
    }
    
    if (data.success) {
      notifications = data.notifications || [];
      const notificationCountElement = document.getElementById('notificationCount');
      if (notificationCountElement) {
        notificationCountElement.textContent = data.unreadCount || '0';
      }
      updateNotificationList();
      updateClearButtons();
      retryCount = 0; // Reset retry count on successful fetch
    } else {
      throw new Error(data.error || 'Failed to fetch notifications');
    }
  } catch (error) {
    console.error('Detailed error in fetchNotifications:', error);
    
    if (error instanceof TypeError && error.message.includes('NetworkError')) {
      if (retryCount < MAX_RETRIES) {
        retryCount++;
        console.log(`Retrying fetch (${retryCount}/${MAX_RETRIES})...`);
        setTimeout(fetchNotifications, RETRY_DELAY);
      } else {
        showErrorMessage('Network error occurred. Please check your internet connection and try again.');
        notifications = [];
        updateNotificationList();
        updateClearButtons();
      }
    } else {
      showErrorMessage('Failed to fetch notifications. Please try again later.');
      notifications = [];
      updateNotificationList();
      updateClearButtons();
    }
  }
}

// Wait for DOM to be fully loaded before running any code
document.addEventListener('DOMContentLoaded', function() {
  console.log("DOM fully loaded, initializing notification system");
  
  try {
    // Initialize notification elements
    const notificationIcon = document.getElementById('notificationIcon');
    const notificationModal = document.getElementById('notificationModal');
    const closeModal = document.getElementById('closeModal');
    const clearSelectedBtn = document.getElementById('clearSelectedBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const notificationCount = document.getElementById('notificationCount');
    const notificationList = document.getElementById('notificationList');
    
    console.log("Notification elements:", {
      notificationIcon: !!notificationIcon,
      notificationModal: !!notificationModal,
      closeModal: !!closeModal,
      clearSelectedBtn: !!clearSelectedBtn,
      clearAllBtn: !!clearAllBtn,
      notificationCount: !!notificationCount,
      notificationList: !!notificationList
    });
    
    // Set up event listeners
    if (notificationIcon) {
      notificationIcon.addEventListener('click', () => {
        console.log("Notification icon clicked");
        if (notificationModal) {
          notificationModal.style.display = 'block';
          updateNotificationList();
        }
      });
    }
    
    if (closeModal) {
      closeModal.addEventListener('click', () => {
        console.log("Close modal clicked");
        if (notificationModal) {
          notificationModal.style.display = 'none';
        }
      });
    }
    
    if (clearSelectedBtn) {
      clearSelectedBtn.addEventListener('click', clearSelectedNotifications);
    }
    
    if (clearAllBtn) {
      clearAllBtn.addEventListener('click', clearAllNotifications);
    }
    
    // Close modal when clicking outside
    window.addEventListener('click', (event) => {
      if (notificationModal && event.target === notificationModal) {
        notificationModal.style.display = 'none';
      }
    });
    
    // Initialize admin popup functionality
    const adminButton = document.getElementById("adminbutton");
    const popup = document.getElementById("adminPopup");
    const closePopup = document.getElementById("closePopup");
    const form = document.getElementById("adminForm");
    
    if (adminButton) {
      adminButton.addEventListener("click", () => {
        if (popup) {
          popup.style.display = "flex";
        }
      });
    }
    
    if (closePopup) {
      closePopup.addEventListener("click", () => {
        if (popup) {
          popup.style.display = "none";
          if (form) {
            form.reset();
          }
        }
      });
    }
    
    // Initialize logout button
    const logoutButton = document.getElementById('logoutButton');
    if (logoutButton) {
      logoutButton.addEventListener('click', async () => {
        try {
          const response = await fetch('/logout', { method: 'POST' });
          if (response.ok) {
            localStorage.clear(); // Clear user data
            window.location.href = 'login.html'; // Redirect to the login page
          } else {
            showErrorMessage('Logout failed. Please try again.');
          }
        } catch (error) {
          console.error('Error during logout:', error);
          showErrorMessage('An error occurred during logout. Please try again.');
        }
      });
    }
    
    // Handle form submission for admin concerns
    if (document.getElementById('adminForm')) {
      document.getElementById('adminForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        
        const subject = document.getElementById('subject').value;
        const message = document.getElementById('message').value;
        const fileInput = document.getElementById('fileInput');
        const selectedFile = fileInput?.files?.[0];
        let fileData = null;

        if (selectedFile) {
          const reader = new FileReader();

          reader.onloadend = async function () {
            // Prepare the file data as base64 for sending
            fileData = reader.result.split(',')[1]; // Get base64 part after the comma

            const concernData = {
              username: localStorage.getItem('username'),
              email: localStorage.getItem('email'),
              subject: subject,
              message: message,
              createdAt: new Date().toISOString().replace('Z', '+00:00'),
              file: fileData,
            };

            try {
              const response = await fetch('/addconcern', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(concernData),
              });

              const result = await response.json();

              if (result.success) {
                alert("Your concern has been submitted successfully!");
                document.getElementById('adminForm').reset();
                document.getElementById('adminPopup').style.display = "none";
              } else {
                alert("Failed to submit the concern. Please try again.");
              }
            } catch (error) {
              console.error('Error submitting concern:', error);
              alert("There was an error submitting your concern. Please try again.");
            }
          };

          reader.readAsDataURL(selectedFile); // Read file as Data URL
        } else {
          const concernData = {
            username: localStorage.getItem('username'),
            email: localStorage.getItem('email'),
            subject: subject,
            message: message,
            createdAt: new Date().toISOString().replace('Z', '+00:00'),
          };

          try {
            const response = await fetch('/addconcern', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(concernData),
            });

            const result = await response.json();

            if (result.success) {
              alert("Your concern has been submitted successfully!");
              document.getElementById('adminForm').reset();
              document.getElementById('adminPopup').style.display = "none";
            } else {
              alert("Failed to submit the concern. Please try again.");
            }
          } catch (error) {
            console.error('Error submitting concern:', error);
            alert("There was an error submitting your concern. Please try again.");
          }
        }
      });
    }
    
    // Fetch notifications initially
    console.log("Initializing first notification fetch");
    fetchNotifications();
    
    // Set up periodic fetching (every 30 seconds)
    setInterval(fetchNotifications, 30000);
    
  } catch (error) {
    console.error("Error during initialization:", error);
    showErrorMessage("Failed to initialize notification system. Please refresh the page.");
  }
});

// Function to handle image loading errors
function handleImageError(img) {
  console.error('Failed to load image:', img.src);
  
  // If the image is already using the fallback path, use a data URI placeholder
  if (img.src.includes('/images/')) {
    img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjAiIGZpbGw9IiNhYWEiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5JbWFnZSBub3QgZm91bmQ8L3RleHQ+PC9zdmc+';
    return;
  }
  
  // Try the /images/ path first
  const imageName = img.src.split('/').pop();
  img.src = `/images/${imageName}`;
}

// Add a global error handler to catch any uncaught errors
window.addEventListener('error', function(event) {
  console.error('Global error caught:', event.error);
  showErrorMessage(`An error occurred: ${event.error?.message || 'Unknown error'}`);
});

console.log("Script loaded successfully");
  </script>
</html>