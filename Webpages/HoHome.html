<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Dashboard</title>
    <link rel="stylesheet" type="text/css" href="/CSS/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      /* Reserve Section in Columns */
      .reserve {
        display: flex;
        justify-content: center; /* Centers content horizontally */
        gap: 20%; /* Space between the buttons */
        text-align: center;
        flex-wrap: wrap; /* Allows buttons to wrap on smaller screens */
      }
 
      .reservetext1 {
        font-size: 40px;
        font-family: "Inter";
        color: #3e0408;
        font-weight: bold;
        margin-top: 10px;
        text-align: center;
        width: 100%; /* Ensure the text takes up full width */
      }
 
      .reserve-item {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
 
      .reserve button {
        border: 2px solid #3e0408;
        background: transparent;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
 
      .reserve button:hover {
        background-color: #3e0408;
        color: #ffffff;
        transform: scale(1.1);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      }
 
      .reserve button img {
        width: 300px;
        height: 300px;
      }
 
      .reserve button:hover img {
        filter: brightness(1.2);
      }
 
      .reservetext,
      .raisetext {
        font-size: 20px;
        font-family: "Inter";
        color: #3e0408;
        font-weight: bold;
        margin-top: 10px;
        padding-top: 20px;
      }
      .button {
        margin-top: auto;
        margin-bottom: 20px; /* Adjust this as needed */
        width: 100%;
        text-align: center;
      }
 
      /* Responsive adjustments for smaller screens */
      @media (max-width: 600px) {
        .search-bar {
          width: 100%;
        }
 
        .top-bar {
          padding: 0 10px;
        }
 
        .reserve {
          flex-direction: column; /* Stack buttons vertically on small screens */
          gap: 20px;
        }
 
        .reservetext1 {
          font-size: 30px; /* Adjust the size for smaller screens */
        }
      }
 
      .popup {
        display: none; /* Hidden by default */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1001;
        justify-content: center;
        align-items: center;
        font-family: sans-serif;
      }

      .popup-content {
        background-color: #ffffff; 
        color: #000000; 
        padding: 20px;
        border: 2px solid #af2630; 
        border-radius: 8px;
        width: 900px;
        height: auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        box-sizing: border-box;
        font-family: sans-serif;
        position: relative; 
      }

      .popup-top-bar {
        background-color: #af2630; 
        color: #ffffff; 
        padding: 10px;
        font-size: 24px;
        font-weight: bold;
        text-align: center;
        border-top-left-radius: 8px; 
        border-top-right-radius: 8px;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
      }

      .popup-content-inner {
        margin-top: 60px; 
      }

      .popup-content label {
        display: block;
        margin: 10px 0 5px;
        font-size: 20px;
        font-weight: bold;
      }

      .popup-content input[type="text"],
      .popup-content textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 20px;
      }

      .popup-content textarea {
        resize: none;
      }

      .popup-buttons {
        display: flex;
        align-items: center;
        justify-content: space-between; 
      }

      #closePopup {
        background-color: #fff;
        color: #af2630;
        border: 2px solid #af2630;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 20px;
        transition: all 0.3s ease;
        margin-right: auto; 
      }

      #closePopup:hover {
        background-color: #d9d9d9;
        border-color: #d9d9d9;
      }

      #sendButton {
        background-color: #fff;
        color: #af2630;
        border: 2px solid #af2630;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 20px;
        transition: all 0.3s ease;
      }

      #sendButton:hover {
        background-color: #d9d9d9;
        border-color: #d9d9d9;
      }

      .file-container {
        align-self: flex-end;  
        margin-top: 10px;
      }
      
      /* Notification Icon Styles */
      .notification-icon {
position: fixed;
top: 7px;
right: 16px;

background: rgb(195, 67, 67);

border-radius: 50%;

width: 40px;

height: 40px;

display: flex;

align-items: center;

justify-content: center;

cursor: pointer;
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
transition: transform 0.2s;
z-index: 1002; /* Ensure it's above the header */
}

      .notification-icon img {
        width: 24px;
        height: 24px;
      }

      .notification-count {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #af2630;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        font-weight: bold;
      }
      
      /* Notification Modal Styles */
      .notification-modal {
        display: none;
        position: fixed;
        top: 70px;
        right: 20px;
        width: 350px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        overflow: hidden;
        max-height: 80vh;
        flex-direction: column;
      }

      .notification-header {
        background-color: #af2630;
        color: white;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .notification-header h2 {
        margin: 0;
        font-size: 18px;
      }

      .close-modal {
        color: white;
        font-size: 24px;
        cursor: pointer;
        position: absolute;
        top: 10px;
        right: 15px;
      }
      .logoutbutton{

        margin-top: auto;

        margin-bottom: 30px; /* Adjust this as needed */

        width: 100%;

        text-align: center;

        }





      .notification-list {
        overflow-y: auto;
        max-height: 60vh;
        padding: 0;
      }

      .notification-actions {
        display: flex;
        justify-content: space-between;
        padding: 15px;
        border-top: 1px solid #eee;
      }

      .clear-btn {
        background-color: #af2630;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }

      .clear-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .no-notifications {
        padding: 20px;
        text-align: center;
        color: #888;
      }
        
      /* Notification Item Styles */
      .notification-item {
        position: relative;
        padding: 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: flex-start;
      }
      
      .notification-item:hover {
        background-color: #f9f9f9;
      }
      
      .notification-checkbox {
        margin-right: 10px;
        margin-top: 3px;
      }
      
      .notification-content {
        flex: 1;
      }
      
      .notification-subject {
        font-weight: bold;
        margin-bottom: 5px;
      }
      
      .notification-message {
        color: #555;
        margin-bottom: 5px;
      }
      
      .notification-timestamp {
        font-size: 0.8em;
        color: #888;
      }
      
      .payment-required {
        color: #af2630;
        font-weight: bold;
        margin-top: 5px;
      }
      
      /* Event Details Modal Styles */
      .event-details-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1003;
        justify-content: center;
        align-items: center;
      }
      
      .event-details-content {
        background-color: white;
        padding: 30px 20px 20px;
        border-radius: 10px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      
      .close-event-details {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 24px;
        cursor: pointer;
        color: #888;
        background: none;
        border: none;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
      }
      
      .close-event-details:hover {
        background-color: #f5f5f5;
      }
      
      .event-detail-row {
        display: flex;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      
      .event-detail-label {
        font-weight: bold;
        width: 120px;
        flex-shrink: 0;
        color: #333;
      }
      
      .event-detail-value {
        flex-grow: 1;
        color: #666;
      }
      
      .event-actions {
        margin-top: 20px;
        text-align: right;
      }
      
      .payment-button {
        background-color: #af2630;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
      }

      #eventDetailsTitle {
        margin: 0 0 20px;
        color: #333;
        font-size: 1.5em;
        padding-right: 30px;
      }

      /* Mobile CSS*/
      @media (max-width: 768px) {
        .notification-modal {
          width: 95vw;
          max-height: 80vh;
          top: 10px;
          right: 10px;
          left: 10px;
        }

        .notification-list {
          max-height: calc(80vh - 140px);
        }

        .notification-item {
          padding: 12px;
        }

        .notification-actions {
          padding: 12px;
        }

        .clear-btn {
          padding: 8px 12px;
          font-size: 0.85rem;
        }
        
        .event-details-content {
          width: 95%;
          max-width: none;
          margin: 10px;
        }
      }

      /* Tablet improvements */
      @media screen and (min-width: 769px) and (max-width: 1024px) {
        .reserve button img {
          width: 250px;
          height: 250px;
        }

        .Welcome {
          margin-left: 90px;
        }

        .form-image-container {
          margin-left: 90px;
        }
      }

      /* Touch device improvements */
      @media (hover: none) {
        .reserve button:hover {
          transform: none;
        }

        .reserve button:active {
          background-color: rgba(62, 4, 8, 0.1);
        }
      }
      .top-bar {
        z-index: 1001; /* Lower z-index than notification icon */
      }
      /* Animation */
      @keyframes slideIn {
        from {
          transform: translate(-50%, -60%);
          opacity: 0;
        }
        to {
          transform: translate(-50%, -50%);
          opacity: 1;
        }
      }
      
      @media screen and (max-width: 768px) {
        /* Sidebar becomes bottom navigation */
        .side-bar {
          position: fixed;
          bottom: 0;
          left: 0;
          width: 100%;
          height: 70px;
          padding: 0;
          display: flex;
          justify-content: space-around;
          align-items: center;
          background-color: #D9D9D9;
          z-index: 1000;
        }

        .Home, .Calendar, .Profile {
          margin: 0;
          display: flex;
          flex-direction: column;
          align-items: center;
        }

        .Home img, .Calendar img, .Profile img {
          width: 30px;
          height: 30px;
        }

        .Home p, .Calendar p, .Profile p {
          margin-top: 4px;
          font-size: 12px;
        }

        /* Welcome section adjustments */
        

        /* Reserve section adjustments */
        .reserve {
          padding: 20px;
          margin-bottom: 80px;
          flex-direction: column;
          align-items: center;
          gap: 20px;
        }

        .reservetext1 {
          font-size: 24px;
          margin-bottom: 20px;
        }

        .reserve-item {
          width: 100%;
          max-width: 300px;
        }

        .reserve button img {
          width: 200px;
          height: 200px;
        }

        /* Popup improvements */
        .popup-content {
          width: 95%;
          max-width: 400px;
          margin: 10px;
          height: auto;
          max-height: 90vh;
        }

        .popup-content-inner {
          margin-top: 50px;
          padding: 10px;
        }

        /* Form inputs */
        .popup-content input[type="text"],
        .popup-content textarea {
          font-size: 16px;
          padding: 12px;
        }

        /* Notification adjustments */
        .notification-icon {
          top: 10px;
          right: 10px;
        }

        /* Button improvements */
        .button {
          position: fixed;
          bottom: 70px;
          left: 0;
          width: 100%;
          background-color: #D9D9D9;
          padding: 10px;
          margin: 0;
          text-align: center;
          z-index: 999;
        }

        /* Improve touch targets */
        button,
        input[type="button"],
        input[type="submit"] {
          min-height: 44px;
          min-width: 44px;
          padding: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="notification-icon" id="notificationIcon">
        <img src="/images/bell.png" alt="Notifications" onerror="handleImageError(this)" />
        <span class="notification-count" id="notificationCount">0</span>
      </div>
    
    <div class="top-bar"></div>
    
    <div class="side-bar">
        <div class="Home">
            <button type="button" id="homebutton" name="homebutton" aria-label="home" onclick="window.location.href='HoHome.html'">
                <img src="/images/house.png" alt="Home" onerror="handleImageError(this)" />
            </button>
            <p>Home</p>
        </div>
        
        <div class="Calendar">
            <button type="button" id="calendarbutton" name="calendarbutton" aria-label="calendar" onclick="window.location.href='calender.html'">
                <img src="/images/Calendar.png" alt="Calendar" onerror="handleImageError(this)" />
            </button>
            <p>Calendar</p>
        </div>
        
        <div class="Profile">
          <button type="button" id="profilebutton" name="profilebutton" aria-label="profile" onclick="window.location.href='profile.html'">
              <img src="/images/profileicon.png" alt="Profile" onerror="handleImageError(this)" />
          </button>
          <p>Profile</p>
      </div>
      
      <div class="logoutbutton">
          <button type="button" id="logoutButton">Logout</button>
      </div>
  </div>
    
  <div class="Welcome">
    <h1>Welcome home!</h1>
    <img src="/images/AvidaSettingsLogo.png" alt="Avida Settings Logo" class="avidalogo" onerror="handleImageError(this)" />
  </div>

  <div class="reserve">
    <p class="reservetext1">What would you like to do?</p>
    
    <div class="reserve-item">
        <button type="button" class="poolbutton" id="poolbutton" name="poolbutton" aria-label="pool" onclick="window.location.href='addevent.html'">
            <img src="/images/pool.png" alt="Pool" onerror="handleImageError(this)" />
        </button>
        <p class="reservetext">Reserve for an Outing or an event?</p>
    </div>
    
    <div class="reserve-item">
        <button type="button" class="adminbutton" id="adminbutton" name="adminbutton" aria-label="admin">
            <img src="/images/Admin.png" alt="Admin" onerror="handleImageError(this)" />
        </button>
        <p class="raisetext">Raise your concern to an admin</p>
    </div>
  </div>
 
    <div id="adminPopup" class="popup">
      <div class="popup-content">
          <div class="popup-top-bar">Raise a Concern</div>
          <div class="popup-content-inner">
              
              <form id="adminForm">
                  <label for="subject">Subject</label>
                  <input type="text" id="subject" name="subject" placeholder="Enter subject" required />
  
                  <label for="message">Message</label>
                
                  <textarea id="message" name="message" placeholder="Enter your message" rows="5" required></textarea>
  
                 

                  <div class="popup-buttons">
                      <button type="button" id="closePopup">Cancel</button>
                      
                      <form action="/upload" method="POST" enctype="multipart/form-data">
                        
                        <input type="file" id="fileInput" name="file" accept="image/*,application/pdf" />

                        <button type="submit" id="sendButton">Send</button>
                      </form>
                  </div>
              </form>
          </div>
      </div>
  </div>
  
  <div class="notification-modal" id="notificationModal">
    <div class="notification-header">
        <h2>Notifications</h2>
        <span class="close-modal" id="closeModal">&times;</span>
    </div>
    <div class="notification-list" id="notificationList"></div>
    <div class="notification-actions">
      <button id="clearSelectedBtn" class="clear-btn">Clear Selected</button>
      <button id="clearAllBtn" class="clear-btn">Clear All</button>
    </div>
  </div>

  <div id="eventDetailsModal" class="event-details-modal">
    <div class="event-details-content">
      <span class="close-event-details" id="closeEventDetails">&times;</span>
      <h3 id="eventDetailsTitle">Event Details</h3>
      
      <div class="event-details-body">
        <div class="event-detail-row">
          <div class="event-detail-label">Event Name:</div>
          <div class="event-detail-value" id="eventDetailsName"></div>
        </div>
        <div class="event-detail-row">
          <div class="event-detail-label">Date:</div>
          <div class="event-detail-value" id="eventDetailsDate"></div>
        </div>
        <div class="event-detail-row">
          <div class="event-detail-label">Time:</div>
          <div class="event-detail-value" id="eventDetailsTime"></div>
        </div>
        <div class="event-detail-row">
          <div class="event-detail-label">Amenity:</div>
          <div class="event-detail-value" id="eventDetailsAmenity"></div>
        </div>
        <div class="event-detail-row">
          <div class="event-detail-label">Status:</div>
          <div class="event-detail-value" id="eventDetailsStatus"></div>
        </div>
        <div class="event-detail-row">
          <div class="event-detail-label">Message:</div>
          <div class="event-detail-value" id="eventDetailsMessage"></div>
        </div>
      </div>
      
      <div class="event-actions" id="eventActions">
        <!-- Payment button will be added here if needed -->
      </div>
    </div>
  </div>
  </body>
  <script>
    // Session check and redirect
    function checkSession() {
        fetch('/api/user-info', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = 'login.html';
                    return null;
                }
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data && data.success) {
                console.log('User is authenticated:', data);
                fetchUserProfile();
                fetchNotifications();
                fetchUserEvents(data.email);
            } else if (data) {
                console.error('Authentication check failed:', data);
                window.location.href = 'login.html';
            }
        })
        .catch(error => {
            console.error('Error checking session:', error);
            window.location.href = 'login.html';
        });
    }

    // Fetch user profile information
    function fetchUserProfile() {
        fetch('/profile', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('username').textContent = data.username;
                document.getElementById('welcomeUsername').textContent = data.firstname || data.username;
            }
        })
        .catch(error => console.error('Error fetching profile:', error));
    }

    // Fetch notifications
    function fetchNotifications() {
        fetch('/api/notifications', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.status === 401) {
                console.log('User not authenticated, redirecting to login');
                window.location.href = 'login.html';
                return null;
            }
            return response.json();
        })
        .then(data => {
            if (!data) return;
            
            console.log('Notifications data:', data);
            
            if (data.success) {
                const notificationCount = document.getElementById('notificationCount');
                notificationCount.textContent = data.unreadCount;
                
                // Store notifications in session storage for use in other functions
                sessionStorage.setItem('notifications', JSON.stringify(data.notifications));
                
                // Update notification list
                updateNotificationList();
            } else {
                console.error('Failed to fetch notifications:', data.error);
            }
        })
        .catch(error => {
            console.error('Error fetching notifications:', error);
        });
    }

    // Update notification list in the dropdown
    function updateNotificationList() {
        const notificationListElement = document.getElementById('notificationList');
        if (!notificationListElement) {
            console.error('Notification list element not found');
            return;
        }

        // Get notifications from session storage
        const notificationsData = sessionStorage.getItem('notifications');
        const notifications = notificationsData ? JSON.parse(notificationsData) : [];

        notificationListElement.innerHTML = ''; // Clear existing list

        if (!notifications || notifications.length === 0) {
            const noNotifications = document.createElement('div');
            noNotifications.classList.add('no-notifications');
            noNotifications.textContent = 'No new notifications';
            notificationListElement.appendChild(noNotifications);
            return;
        }

        notifications.forEach(notification => {
            const notificationItem = document.createElement('div');
            notificationItem.classList.add('notification-item');

            // Create checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'notification-checkbox';
            checkbox.dataset.id = notification._id;

            // Create content wrapper
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'notification-content';

            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.className = 'notification-message';
            messageDiv.textContent = notification.message;

            // Create timestamp element
            const timestampDiv = document.createElement('div');
            timestampDiv.className = 'notification-timestamp';
            timestampDiv.textContent = new Date(notification.timestamp).toLocaleString();

            // Add message and timestamp to content wrapper
            contentWrapper.appendChild(messageDiv);
            contentWrapper.appendChild(timestampDiv);

            // Add elements to notification item
            notificationItem.appendChild(checkbox);
            notificationItem.appendChild(contentWrapper);

            // If it's an event notification that requires payment, add the proceed button
            if (notification.type === 'payment_required') {
                const proceedButton = document.createElement('button');
                proceedButton.className = 'proceed-to-payment-btn';
                proceedButton.textContent = 'Proceed to Payment';
                proceedButton.onclick = () => proceedToPayment(notification);
                notificationItem.appendChild(proceedButton);
            }

            notificationListElement.appendChild(notificationItem);
        });
    }

    // Function to proceed to payment
    function proceedToPayment(notification) {
        // Check if notification has a relatedId
        if (!notification.relatedId) {
            alert('Error: Missing event ID. Please contact support.');
            return;
        }

        const eventId = notification.relatedId;
        console.log('Proceeding to payment for event ID:', eventId);

        // Show loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.textContent = 'Loading event details...';
        loadingDiv.style.position = 'fixed';
        loadingDiv.style.top = '50%';
        loadingDiv.style.left = '50%';
        loadingDiv.style.transform = 'translate(-50%, -50%)';
        loadingDiv.style.padding = '20px';
        loadingDiv.style.background = 'white';
        loadingDiv.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
        loadingDiv.style.borderRadius = '5px';
        loadingDiv.style.zIndex = '9999';
        document.body.appendChild(loadingDiv);

        // Fetch the event
        fetch(`/api/event/${eventId}`, {
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(eventData => {
            document.body.removeChild(loadingDiv); // Remove loading indicator

            if (eventData.success) {
                console.log('Event data received:', eventData.event);
                // Store the event data in sessionStorage
                sessionStorage.setItem('eventData', JSON.stringify(eventData.event));
                // Redirect to the payment page
                window.location.href = 'payment.html';
            } else {
                console.error('API returned error:', eventData);
                throw new Error(eventData.message || 'Unknown error');
            }
        })
        .catch(error => {
            if (document.body.contains(loadingDiv)) {
                document.body.removeChild(loadingDiv); // Remove loading indicator if still present
            }
            console.error('Error fetching event details:', error);

            // Offer alternative options
            const useManualEntry = confirm(
                'Failed to fetch event details automatically. Would you like to enter event details manually?\n\n' +
                'Error: ' + error.message
            );

            if (useManualEntry) {
                // Create a minimal event object with data from the notification
                const minimalEvent = {
                    userEmail: notification.userEmail || '',
                    eventName: notification.eventName || 'Unknown Event',
                    eventDate: notification.eventDate || new Date().toISOString().split('T')[0],
                    startTime: notification.startTime || '09:00',
                    endTime: notification.endTime || '12:00',
                    amenity: notification.amenity || 'Unknown',
                };

                sessionStorage.setItem('eventData', JSON.stringify(minimalEvent));
                window.location.href = 'payment.html';
            }
        });
    }

    // Function to mark selected notifications as read
    function markSelectedNotificationsAsRead() {
        const checkboxes = document.querySelectorAll('.notification-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Please select at least one notification to mark as read.');
            return;
        }

        const notificationIds = Array.from(checkboxes).map(checkbox => checkbox.dataset.id);

        fetch('/api/markNotificationsAsRead', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ notificationIds }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Notifications marked as read:', data);
                fetchNotifications(); // Refresh notifications
            } else {
                console.error('Failed to mark notifications as read:', data);
            }
        })
        .catch(error => {
            console.error('Error marking notifications as read:', error);
        });
    }

    // Function to clear all notifications
    function clearAllNotifications() {
        if (confirm('Are you sure you want to clear all notifications?')) {
            fetch('/api/clearAllNotifications', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('All notifications cleared:', data);
                    fetchNotifications(); // Refresh notifications
                } else {
                    console.error('Failed to clear notifications:', data);
                }
            })
            .catch(error => {
                console.error('Error clearing notifications:', error);
            });
        }
    }

    // Function to clear selected notifications
    function clearSelectedNotifications() {
        const checkboxes = document.querySelectorAll('.notification-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Please select at least one notification to clear.');
            return;
        }

        const notificationIds = Array.from(checkboxes).map(checkbox => checkbox.dataset.id);

        fetch('/api/clearSelectedNotifications', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ notificationIds }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Selected notifications cleared:', data);
                fetchNotifications(); // Refresh notifications
            } else {
                console.error('Failed to clear selected notifications:', data);
            }
        })
        .catch(error => {
            console.error('Error clearing selected notifications:', error);
        });
    }

    // Fetch user events
    function fetchUserEvents(userEmail) {
        if (!userEmail) {
            console.error('User email is required to fetch events');
            return;
        }

        fetch(`/api/user-events/${userEmail}`, {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateRecentReservations(data.events);
                updateReservationStats(data.events);
                document.getElementById('upcomingReservations').textContent = 
                    data.events.filter(event => new Date(event.eventDate) >= new Date()).length;
            } else {
                console.log('No events found or error:', data.message);
            }
        })
        .catch(error => {
            console.error('Error fetching user events:', error);
        });
    }

    // Update recent reservations section
    function updateRecentReservations(events) {
        const recentReservationsElement = document.getElementById('recentReservations');
        recentReservationsElement.innerHTML = '';

        if (!events || events.length === 0) {
            const noData = document.createElement('p');
            noData.className = 'no-data';
            noData.textContent = 'No recent reservations found.';
            recentReservationsElement.appendChild(noData);
            return;
        }

        // Sort events by date (most recent first)
        const sortedEvents = [...events].sort((a, b) => new Date(b.eventDate) - new Date(a.eventDate));
        
        // Take only the 3 most recent events
        const recentEvents = sortedEvents.slice(0, 3);

        recentEvents.forEach(event => {
            const reservationCard = document.createElement('div');
            reservationCard.className = 'reservation-card';

            const title = document.createElement('h3');
            title.textContent = event.eventName;
            
            const details = document.createElement('div');
            details.className = 'reservation-details';
            
            const date = document.createElement('p');
            date.innerHTML = `<strong>Date:</strong> ${new Date(event.eventDate).toLocaleDateString()}`;
            
            const time = document.createElement('p');
            time.innerHTML = `<strong>Time:</strong> ${event.startTime} - ${event.endTime}`;
            
            const amenity = document.createElement('p');
            amenity.innerHTML = `<strong>Amenity:</strong> ${event.amenity}`;
            
            details.appendChild(date);
            details.appendChild(time);
            details.appendChild(amenity);
            
            reservationCard.appendChild(title);
            reservationCard.appendChild(details);
            
            recentReservationsElement.appendChild(reservationCard);
        });
    }

    // Update reservation statistics chart
    function updateReservationStats(events) {
        if (!events || events.length === 0) return;

        // Count reservations by amenity
        const amenityCounts = {};
        events.forEach(event => {
            const amenity = event.amenity || 'Unknown';
            amenityCounts[amenity] = (amenityCounts[amenity] || 0) + 1;
        });

        const ctx = document.getElementById('reservationChart').getContext('2d');
        
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(amenityCounts),
                datasets: [{
                    data: Object.values(amenityCounts),
                    backgroundColor: [
                        '#4e73df',
                        '#1cc88a',
                        '#36b9cc',
                        '#f6c23e',
                        '#e74a3b'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Reservations by Amenity'
                    }
                }
            }
        });
    }

    // Fetch available amenities
    function fetchAvailableAmenities() {
        fetch('/getCurrentlyReservedAmenities')
        .then(response => response.json())
        .then(amenities => {
            const amenityCardsElement = document.getElementById('amenityCards');
            amenityCardsElement.innerHTML = '';

            if (amenities.length === 0) {
                const noAmenities = document.createElement('p');
                noAmenities.className = 'no-data';
                noAmenities.textContent = 'No amenities are currently reserved.';
                amenityCardsElement.appendChild(noAmenities);
                return;
            }

            amenities.forEach(amenity => {
                const card = document.createElement('div');
                card.className = 'amenity-card';
                
                const image = document.createElement('img');
                image.src = amenity.imagePath;
                image.alt = amenity.name;
                
                const name = document.createElement('h3');
                name.textContent = amenity.name;
                
                const status = document.createElement('span');
                status.className = 'status reserved';
                status.textContent = 'Reserved Today';
                
                card.appendChild(image);
                card.appendChild(name);
                card.appendChild(status);
                
                amenityCardsElement.appendChild(card);
            });
        })
        .catch(error => {
            console.error('Error fetching amenities:', error);
        });
    }

    // Logout function
    function logout() {
        fetch('/logout', {
            method: 'POST',
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            console.log('Logout response:', data);
            window.location.href = 'login.html';
        })
        .catch(error => {
            console.error('Error during logout:', error);
            // Redirect anyway
            window.location.href = 'login.html';
        });
    }

    // Function to clear selected notifications
    function clearSelectedNotifications() {
        const checkboxes = document.querySelectorAll('.notification-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Please select at least one notification to clear.');
            return;
        }

        const notificationIds = Array.from(checkboxes).map(checkbox => checkbox.dataset.id);

        fetch('/api/clearSelectedNotifications', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ notificationIds }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Selected notifications cleared:', data);
                fetchNotifications(); // Refresh notifications
            } else {
                console.error('Failed to clear selected notifications:', data);
            }
        })
        .catch(error => {
            console.error('Error clearing selected notifications:', error);
        });
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Check session and load user data
        checkSession();
        
        // Fetch available amenities
        fetchAvailableAmenities();
        
        // Notification dropdown toggle
        const notificationIcon = document.getElementById('notificationIcon');
        const notificationDropdown = document.getElementById('notificationDropdown');
        
        notificationIcon.addEventListener('click', function() {
            notificationDropdown.classList.toggle('show');
        });
        
        // Close dropdown when clicking outside
        window.addEventListener('click', function(event) {
            if (!event.target.matches('.notification-icon') && 
                !event.target.matches('.fa-bell') && 
                !notificationDropdown.contains(event.target)) {
                notificationDropdown.classList.remove('show');
            }
        });
        
        // Mark all notifications as read
        document.getElementById('markAllReadBtn').addEventListener('click', markSelectedNotificationsAsRead);
        
        // Clear all notifications
        document.getElementById('clearAllBtn').addEventListener('click', clearAllNotifications);
        
        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            logout();
        });
    });
</script>
</html>

