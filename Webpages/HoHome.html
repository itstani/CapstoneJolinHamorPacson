<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Dashboard</title>
    <link rel="stylesheet" type="text/css" href="/CSS/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      /* Reserve Section in Columns */
      .reserve {
        display: flex;
        justify-content: center; /* Centers content horizontally */
        gap: 20%; /* Space between the buttons */
        text-align: center;
        flex-wrap: wrap; /* Allows buttons to wrap on smaller screens */
      }
 
      .reservetext1 {
        font-size: 40px;
        font-family: "Inter";
        color: #3e0408;
        font-weight: bold;
        margin-top: 10px;
        text-align: center;
        width: 100%; /* Ensure the text takes up full width */
      }
 
      .reserve-item {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
 
      .reserve button {
        border: 2px solid #3e0408;
        background: transparent;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
 
      .reserve button:hover {
        background-color: #3e0408;
        color: #ffffff;
        transform: scale(1.1);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      }
 
      .reserve button img {
        width: 300px;
        height: 300px;
      }
 
      .reserve button:hover img {
        filter: brightness(1.2);
      }
 
      .reservetext,
      .raisetext {
        font-size: 20px;
        font-family: "Inter";
        color: #3e0408;
        font-weight: bold;
        margin-top: 10px;
        padding-top: 20px;
      }
      .button {
        margin-top: auto;
        margin-bottom: 20px; /* Adjust this as needed */
        width: 100%;
        text-align: center;
      }
 
      /* Responsive adjustments for smaller screens */
      @media (max-width: 600px) {
        .search-bar {
          width: 100%;
        }
 
        .top-bar {
          padding: 0 10px;
        }
 
        .reserve {
          flex-direction: column; /* Stack buttons vertically on small screens */
          gap: 20px;
        }
 
        .reservetext1 {
          font-size: 30px; /* Adjust the size for smaller screens */
        }
      }
 
      .popup {
        display: none; /* Hidden by default */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1001;
        justify-content: center;
        align-items: center;
        font-family: sans-serif;
      }

      .popup-content {
        background-color: #ffffff; 
        color: #000000; 
        padding: 20px;
        border: 2px solid #af2630; 
        border-radius: 8px;
        width: 900px;
        height: auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        box-sizing: border-box;
        font-family: sans-serif;
        position: relative; 
      }

      .popup-top-bar {
        background-color: #af2630; 
        color: #ffffff; 
        padding: 10px;
        font-size: 24px;
        font-weight: bold;
        text-align: center;
        border-top-left-radius: 8px; 
        border-top-right-radius: 8px;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
      }

      .popup-content-inner {
        margin-top: 60px; 
      }

      .popup-content label {
        display: block;
        margin: 10px 0 5px;
        font-size: 20px;
        font-weight: bold;
      }

      .popup-content input[type="text"],
      .popup-content textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 20px;
      }

      .popup-content textarea {
        resize: none;
      }

      .popup-buttons {
        display: flex;
        align-items: center;
        justify-content: space-between; 
      }

      #closePopup {
        background-color: #fff;
        color: #af2630;
        border: 2px solid #af2630;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 20px;
        transition: all 0.3s ease;
        margin-right: auto; 
      }

      #closePopup:hover {
        background-color: #d9d9d9;
        border-color: #d9d9d9;
      }

      #sendButton {
        background-color: #fff;
        color: #af2630;
        border: 2px solid #af2630;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 20px;
        transition: all 0.3s ease;
      }

      #sendButton:hover {
        background-color: #d9d9d9;
        border-color: #d9d9d9;
      }

      .file-container {
        align-self: flex-end;  
        margin-top: 10px;
      }
      
      /* Notification Icon Styles */
      .notification-icon {
position: fixed;
top: 7px;
right: 16px;

background: rgb(195, 67, 67);

border-radius: 50%;

width: 40px;

height: 40px;

display: flex;

align-items: center;

justify-content: center;

cursor: pointer;
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
transition: transform 0.2s;
z-index: 1002; /* Ensure it's above the header */
}

      .notification-icon img {
        width: 24px;
        height: 24px;
      }

      .notification-count {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #af2630;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        font-weight: bold;
      }
      
      /* Notification Modal Styles */
      .notification-modal {
        display: none;
        position: fixed;
        top: 70px;
        right: 20px;
        width: 350px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        overflow: hidden;
        max-height: 80vh;
        flex-direction: column;
      }

      .notification-header {
        background-color: #af2630;
        color: white;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .notification-header h2 {
        margin: 0;
        font-size: 18px;
      }

      .close-modal {
        color: white;
        font-size: 24px;
        cursor: pointer;
        position: absolute;
        top: 10px;
        right: 15px;
      }
      .logoutbutton{

        margin-top: auto;

        margin-bottom: 30px; /* Adjust this as needed */

        width: 100%;

        text-align: center;

        }





      .notification-list {
        overflow-y: auto;
        max-height: 60vh;
        padding: 0;
      }

      .notification-actions {
        display: flex;
        justify-content: space-between;
        padding: 15px;
        border-top: 1px solid #eee;
      }

      .clear-btn {
        background-color: #af2630;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }

      .clear-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .no-notifications {
        padding: 20px;
        text-align: center;
        color: #888;
      }
        
      /* Notification Item Styles */
      .notification-item {
        position: relative;
        padding: 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: flex-start;
      }
      
      .notification-item:hover {
        background-color: #f9f9f9;
      }
      
      .notification-checkbox {
        margin-right: 10px;
        margin-top: 3px;
      }
      
      .notification-content {
        flex: 1;
      }
      
      .notification-subject {
        font-weight: bold;
        margin-bottom: 5px;
      }
      
      .notification-message {
        color: #555;
        margin-bottom: 5px;
      }
      
      .notification-timestamp {
        font-size: 0.8em;
        color: #888;
      }
      
      .payment-required {
        color: #af2630;
        font-weight: bold;
        margin-top: 5px;
      }
      
      /* Event Details Modal Styles */
      .event-details-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1003;
        justify-content: center;
        align-items: center;
      }
      
      .event-details-content {
        background-color: white;
        padding: 30px 20px 20px;
        border-radius: 10px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      
      .close-event-details {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 24px;
        cursor: pointer;
        color: #888;
        background: none;
        border: none;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
      }
      
      .close-event-details:hover {
        background-color: #f5f5f5;
      }
      
      .event-detail-row {
        display: flex;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      
      .event-detail-label {
        font-weight: bold;
        width: 120px;
        flex-shrink: 0;
        color: #333;
      }
      
      .event-detail-value {
        flex-grow: 1;
        color: #666;
      }
      
      .event-actions {
        margin-top: 20px;
        text-align: right;
      }
      
      .payment-button {
        background-color: #af2630;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
      }

      #eventDetailsTitle {
        margin: 0 0 20px;
        color: #333;
        font-size: 1.5em;
        padding-right: 30px;
      }

      /* Mobile CSS*/
      @media (max-width: 768px) {
        .notification-modal {
          width: 95vw;
          max-height: 80vh;
          top: 10px;
          right: 10px;
          left: 10px;
        }

        .notification-list {
          max-height: calc(80vh - 140px);
        }

        .notification-item {
          padding: 12px;
        }

        .notification-actions {
          padding: 12px;
        }

        .clear-btn {
          padding: 8px 12px;
          font-size: 0.85rem;
        }
        
        .event-details-content {
          width: 95%;
          max-width: none;
          margin: 10px;
        }
      }

      /* Tablet improvements */
      @media screen and (min-width: 769px) and (max-width: 1024px) {
        .reserve button img {
          width: 250px;
          height: 250px;
        }

        .Welcome {
          margin-left: 90px;
        }

        .form-image-container {
          margin-left: 90px;
        }
      }

      /* Touch device improvements */
      @media (hover: none) {
        .reserve button:hover {
          transform: none;
        }

        .reserve button:active {
          background-color: rgba(62, 4, 8, 0.1);
        }
      }
      .top-bar {
        z-index: 1001; /* Lower z-index than notification icon */
      }
      /* Animation */
      @keyframes slideIn {
        from {
          transform: translate(-50%, -60%);
          opacity: 0;
        }
        to {
          transform: translate(-50%, -50%);
          opacity: 1;
        }
      }
      
      @media screen and (max-width: 768px) {
        /* Sidebar becomes bottom navigation */
        .side-bar {
          position: fixed;
          bottom: 0;
          left: 0;
          width: 100%;
          height: 70px;
          padding: 0;
          display: flex;
          justify-content: space-around;
          align-items: center;
          background-color: #D9D9D9;
          z-index: 1000;
        }

        .Home, .Calendar, .Profile {
          margin: 0;
          display: flex;
          flex-direction: column;
          align-items: center;
        }

        .Home img, .Calendar img, .Profile img {
          width: 30px;
          height: 30px;
        }

        .Home p, .Calendar p, .Profile p {
          margin-top: 4px;
          font-size: 12px;
        }

        /* Welcome section adjustments */
        

        /* Reserve section adjustments */
        .reserve {
          padding: 20px;
          margin-bottom: 80px;
          flex-direction: column;
          align-items: center;
          gap: 20px;
        }

        .reservetext1 {
          font-size: 24px;
          margin-bottom: 20px;
        }

        .reserve-item {
          width: 100%;
          max-width: 300px;
        }

        .reserve button img {
          width: 200px;
          height: 200px;
        }

        /* Popup improvements */
        .popup-content {
          width: 95%;
          max-width: 400px;
          margin: 10px;
          height: auto;
          max-height: 90vh;
        }

        .popup-content-inner {
          margin-top: 50px;
          padding: 10px;
        }

        /* Form inputs */
        .popup-content input[type="text"],
        .popup-content textarea {
          font-size: 16px;
          padding: 12px;
        }

        /* Notification adjustments */
        .notification-icon {
          top: 10px;
          right: 10px;
        }

        /* Button improvements */
        .button {
          position: fixed;
          bottom: 70px;
          left: 0;
          width: 100%;
          background-color: #D9D9D9;
          padding: 10px;
          margin: 0;
          text-align: center;
          z-index: 999;
        }

        /* Improve touch targets */
        button,
        input[type="button"],
        input[type="submit"] {
          min-height: 44px;
          min-width: 44px;
          padding: 12px;
        }
      }
      .avidalogo {
  max-width: 300px;
  width: 100%;
  height: auto; /* This maintains the aspect ratio */
  margin-left: 50px;
  padding-top: 20px; /* Using fixed padding instead of percentage */
  display: block; /* Ensures proper rendering */
}

/* Add responsive adjustments */
@media screen and (max-width: 768px) {
  .avidalogo {
    max-width: 200px;
    margin-left: 20px;
    padding-top: 10px;
  }
}
    </style>
  </head>
  <body>
    <div class="notification-icon" id="notificationIcon">
        <img src="/images/bell.png" alt="Notifications" onerror="handleImageError(this)" />
        <span class="notification-count" id="notificationCount">0</span>
      </div>
    
    <div class="top-bar"></div>
    
    <div class="side-bar">
        <div class="Home">
            <button type="button" id="homebutton" name="homebutton" aria-label="home" onclick="window.location.href='HoHome.html'">
                <img src="/images/house.png" alt="Home" onerror="handleImageError(this)" />
            </button>
            <p>Home</p>
        </div>
        
        <div class="Calendar">
            <button type="button" id="calendarbutton" name="calendarbutton" aria-label="calendar" onclick="window.location.href='calender.html'">
                <img src="/images/Calendar.png" alt="Calendar" onerror="handleImageError(this)" />
            </button>
            <p>Calendar</p>
        </div>
        
        <div class="Profile">
          <button type="button" id="profilebutton" name="profilebutton" aria-label="profile" onclick="window.location.href='profile.html'">
              <img src="/images/profileicon.png" alt="Profile" onerror="handleImageError(this)" />
          </button>
          <p>Profile</p>
      </div>
      
      <div class="logoutbutton">
          <button type="button" id="logoutButton">Logout</button>
      </div>
  </div>
    
  <div class="Welcome">
    <h1>Welcome home!</h1>
    <img src="/images/AvidaSettingsLogo.png" alt="Avida Settings Logo" class="avidalogo" onerror="handleImageError(this)" />
  </div>

  <div class="reserve">
    <p class="reservetext1">What would you like to do?</p>
    
    <div class="reserve-item">
        <button type="button" class="poolbutton" id="poolbutton" name="poolbutton" aria-label="pool" onclick="window.location.href='addevent.html'">
            <img src="/images/pool.png" alt="Pool" onerror="handleImageError(this)" />
        </button>
        <p class="reservetext">Reserve for an Outing or an event?</p>
    </div>
    
    <div class="reserve-item">
        <button type="button" class="adminbutton" id="adminbutton" name="adminbutton" aria-label="admin">
            <img src="/images/Admin.png" alt="Admin" onerror="handleImageError(this)" />
        </button>
        <p class="raisetext">Raise your concern to an admin</p>
    </div>
  </div>
 
    <div id="adminPopup" class="popup">
      <div class="popup-content">
          <div class="popup-top-bar">Raise a Concern</div>
          <div class="popup-content-inner">
              
              <form id="adminForm">
                  <label for="subject">Subject</label>
                  <input type="text" id="subject" name="subject" placeholder="Enter subject" required />
  
                  <label for="message">Message</label>
                
                  <textarea id="message" name="message" placeholder="Enter your message" rows="5" required></textarea>
  
                 

                  <div class="popup-buttons">
                      <button type="button" id="closePopup">Cancel</button>
                      
                      <form action="/upload" method="POST" enctype="multipart/form-data">
                        
                        <input type="file" id="fileInput" name="file" accept="image/*,application/pdf" />

                        <button type="submit" id="sendButton">Send</button>
                      </form>
                  </div>
              </form>
          </div>
      </div>
  </div>
  
  <div class="notification-modal" id="notificationModal">
    <div class="notification-header">
        <h2>Notifications</h2>
        <span class="close-modal" id="closeModal">&times;</span>
    </div>
    <div class="notification-list" id="notificationList"></div>
    <div class="notification-actions">
      <button id="clearSelectedBtn" class="clear-btn">Clear Selected</button>
      <button id="clearAllBtn" class="clear-btn">Clear All</button>
    </div>
  </div>

  <div id="eventDetailsModal" class="event-details-modal">
    <div class="event-details-content">
      <span class="close-event-details" id="closeEventDetails">&times;</span>
      <h3 id="eventDetailsTitle">Event Details</h3>
      
      <div class="event-details-body">
        <div class="event-detail-row">
          <div class="event-detail-label">Event Name:</div>
          <div class="event-detail-value" id="eventDetailsName"></div>
        </div>
        <div class="event-detail-row">
          <div class="event-detail-label">Date:</div>
          <div class="event-detail-value" id="eventDetailsDate"></div>
        </div>
        <div class="event-detail-row">
          <div class="event-detail-label">Time:</div>
          <div class="event-detail-value" id="eventDetailsTime"></div>
        </div>
        <div class="event-detail-row">
          <div class="event-detail-label">Amenity:</div>
          <div class="event-detail-value" id="eventDetailsAmenity"></div>
        </div>
        <div class="event-detail-row">
          <div class="event-detail-label">Status:</div>
          <div class="event-detail-value" id="eventDetailsStatus"></div>
        </div>
        <div class="event-detail-row">
          <div class="event-detail-label">Message:</div>
          <div class="event-detail-value" id="eventDetailsMessage"></div>
        </div>
      </div>
      
      <div class="event-actions" id="eventActions">
        <!-- Payment button will be added here if needed -->
      </div>
    </div>
  </div>
  </body>
  <script>
let notifications = [];
const MAX_RETRIES = 3;
const RETRY_DELAY = 2000;
let retryCount = 0;
let currentNotification = null;

// Function to update the notification list in the UI - defined first since it's used by multiple functions
function updateNotificationList() {
  const notificationList = document.getElementById('notificationList');
  if (!notificationList) {
    console.error('Notification list element not found');
    return;
  }

  notificationList.innerHTML = ''; // Clear existing list

  if (!notifications || notifications.length === 0) {
    const noNotifications = document.createElement('div');
    noNotifications.classList.add('no-notifications');
    noNotifications.textContent = 'No new notifications';
    notificationList.appendChild(noNotifications);
    return;
  }

  notifications.forEach((notification) => {
    // Skip deleted event notifications
    if (notification.type === 'event_deleted') {
      return;
    }

    const notificationItem = document.createElement('div');
    notificationItem.classList.add('notification-item');
    notificationItem.dataset.id = notification._id;
    
    // Create checkbox
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'notification-checkbox';
    checkbox.dataset.id = notification._id;
    checkbox.onclick = (e) => e.stopPropagation(); // Prevent opening modal when clicking checkbox

    // Create content wrapper
    const contentWrapper = document.createElement('div');
    contentWrapper.className = 'notification-content';
    
    // Create subject line
    const subjectDiv = document.createElement('div');
    subjectDiv.className = 'notification-subject';
    
    // Format the subject line based on notification data
    let subject = notification.subject || '';
    if (!subject && notification.message) {
      // Try to extract event name and date from message if subject is not available
      const eventNameMatch = notification.message.match(/"([^"]+)"/);
      const eventName = eventNameMatch ? eventNameMatch[1] : 'Event';
      
      // Try to extract date from message or use a placeholder
      const dateMatch = notification.message.match(/(\d{4}-\d{2}-\d{2})/);
      const date = dateMatch ? dateMatch[1] : '';
      
      subject = `${eventName}${date ? ' on ' + date : ''}`;
    }
    subjectDiv.textContent = subject;

    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = 'notification-message';
    messageDiv.textContent = notification.message;

    // Create timestamp element
    const timestampDiv = document.createElement('div');
    timestampDiv.className = 'notification-timestamp';
    timestampDiv.textContent = new Date(notification.timestamp).toLocaleString();

    // Add payment required indicator if needed
    if (notification.type === 'payment_required') {
      const paymentRequiredDiv = document.createElement('div');
      paymentRequiredDiv.className = 'payment-required';
      paymentRequiredDiv.textContent = 'Payment Required';
      contentWrapper.appendChild(paymentRequiredDiv);
    }

    // Add subject, message and timestamp to content wrapper
    contentWrapper.appendChild(subjectDiv);
    contentWrapper.appendChild(messageDiv);
    contentWrapper.appendChild(timestampDiv);

    // Add elements to notification item
    notificationItem.appendChild(checkbox);
    notificationItem.appendChild(contentWrapper);

    // Check if this is an admin response/concern notification
    const isAdminResponse = 
      notification.type === 'concern' || 
      notification.type === 'new_concern' || 
      notification.isAdminResponse === true ||
      (notification.subject && notification.subject.toLowerCase().includes('concern'));
    
    if (isAdminResponse) {
      // For admin responses, show the custom popup with the message
      notificationItem.addEventListener('click', (e) => {
        if (e.target !== checkbox) {
          showAdminResponsePopup(`Admin Response: ${notification.message}`);
        }
      });
    } else {
      // For event notifications, show the event details modal
      notificationItem.addEventListener('click', (e) => {
        if (e.target !== checkbox) {
          showEventDetails(notification);
        }
      });
    }

    notificationList.appendChild(notificationItem);
  });
}

function showEventDetails(notification) {
  console.log("Showing event details for notification:", notification);
  
  // First, check if this is actually an event notification
  const isEventNotification = 
    notification.eventName || 
    notification.eventDate || 
    notification.amenity ||
    notification.type === 'payment_required' ||
    notification.type === 'payment_confirmed' ||
    notification.type === 'event_confirmed';
  
  // Check if this is an admin response
  const isAdminResponse = 
    notification.type === 'concern' || 
    notification.type === 'new_concern' || 
    notification.isAdminResponse === true ||
    (notification.subject && notification.subject.toLowerCase().includes('concern'));
  
  if (isAdminResponse || !isEventNotification) {
    console.log("This is not an event notification:", notification);
    alert(`Admin Response: ${notification.message}`);
    return;
  }
  
  currentNotification = notification;

  // Close the notification modal
  const notificationModal = document.getElementById('notificationModal');
  if (notificationModal) {
    notificationModal.style.display = 'none';
  }

  // Extract event name
  let displayEventName = notification.eventName || 'N/A';
  if (!displayEventName || displayEventName === 'N/A') {
    const match = notification.message?.match(/"([^"]+)"/);
    if (match && match[1]) {
      displayEventName = match[1];
    } else if (notification.subject) {
      const subjectParts = notification.subject.split(' on ');
      if (subjectParts.length > 0) {
        displayEventName = subjectParts[0];
      }
    }
  }
  document.getElementById('eventDetailsName').textContent = displayEventName;

  // Extract date
  let displayDate = notification.eventDate || 'N/A';
  if (!displayDate || displayDate === 'N/A') {
    if (notification.subject) {
      const dateMatch = notification.subject.match(/on\s+(\d{4}-\d{2}-\d{2})/);
      if (dateMatch && dateMatch[1]) {
        displayDate = dateMatch[1];
      }
    }
    if ((!displayDate || displayDate === 'N/A') && notification.message) {
      const dateMatch = notification.message.match(/(\d{4}-\d{2}-\d{2})/);
      if (dateMatch && dateMatch[1]) {
        displayDate = dateMatch[1];
      }
    }
  }
  document.getElementById('eventDetailsDate').textContent = displayDate;

  // Extract time
  let displayTime = 'N/A';
  
  // First check direct properties
  if (notification.startTime && notification.endTime) {
    displayTime = `${notification.startTime} - ${notification.endTime}`;
  } 
  // Then check subject - specifically for the format in your data
  else if (notification.subject && notification.subject.includes('PM-')) {
    // Handle the specific format in your data like "Liga on 2025-03-20 4: PM-6: PM"
    const timeMatch = notification.subject.match(/(\d+:\s*PM)-(\d+:\s*PM)/i);
    if (timeMatch && timeMatch[1] && timeMatch[2]) {
      displayTime = `${timeMatch[1].trim()} - ${timeMatch[2].trim()}`;
    }
  }
  // Try other patterns if still not found
  else if (notification.subject) {
    const timeMatch = notification.subject.match(/(\d{1,2}:\d{2}(?:\s*[AP]M)?)\s*-\s*(\d{1,2}:\d{2}(?:\s*[AP]M)?)/i);
    if (timeMatch && timeMatch[1] && timeMatch[2]) {
      displayTime = `${timeMatch[1].trim()} - ${timeMatch[2].trim()}`;
    }
  }
  document.getElementById('eventDetailsTime').textContent = displayTime;

  // Extract amenity
  let displayAmenity = notification.amenity || 'N/A';
  if (!displayAmenity || displayAmenity === 'N/A') {
    if (notification.message) {
      const amenityMatch = notification.message.match(/at\s+([A-Za-z]+)/i);
      if (amenityMatch && amenityMatch[1]) {
        displayAmenity = amenityMatch[1];
      }
    }
  }
  document.getElementById('eventDetailsAmenity').textContent = displayAmenity;

  // Determine if payment is required based on multiple factors
  let requiresPayment = false;
  let status = 'Confirmed';

  // Check explicit payment indicators
  if (notification.type === 'payment_required') {
    requiresPayment = true;
    status = 'Payment Required';
  } else if (notification.type === 'payment_confirmed' || notification.paymentStatus === 'paid' || notification.isPaid === true) {
    status = 'Payment Confirmed';
  } else if (notification.type === 'event_cancelled' || notification.type === 'event_deleted') {
    status = 'Cancelled';
  } else if (notification.message && notification.message.includes('proceed with the payment')) {
    // If message mentions payment but no other indicators suggest it's been paid
    if (!(notification.type === 'payment_confirmed' || notification.paymentStatus === 'paid' || notification.isPaid === true)) {
      requiresPayment = true;
      status = 'Payment Required';
    }
  }

  // Check event type - certain types typically don't require payment
  const freeEventTypes = ['birthday', 'meeting', 'community'];
  if (notification.eventType && freeEventTypes.includes(notification.eventType.toLowerCase())) {
    requiresPayment = false;
    if (status === 'Payment Required') {
      status = 'Confirmed'; // Override status for free event types
    }
  }

  // Check event name for keywords that suggest it's a birthday event
  const birthdayKeywords = ['birthday', 'bday', 'celebration', 'anniversary'];
  const eventNameLower = displayEventName.toLowerCase();
  if (birthdayKeywords.some(keyword => eventNameLower.includes(keyword))) {
    requiresPayment = false;
    if (status === 'Payment Required') {
      status = 'Confirmed'; // Override status for birthday events
    }
  }

  document.getElementById('eventDetailsStatus').textContent = status;
  
  // Set message
  document.getElementById('eventDetailsMessage').textContent = notification.message || '';

  // Add payment button ONLY if payment is required
  const actionsDiv = document.getElementById('eventActions');
  actionsDiv.innerHTML = '';
  
  if (requiresPayment) {
    const paymentButton = document.createElement('button');
    paymentButton.className = 'payment-button';
    paymentButton.textContent = 'Proceed to Payment';
    paymentButton.onclick = () => proceedToPayment(notification);
    actionsDiv.appendChild(paymentButton);
  }

  // Show the modal
  const eventDetailsModal = document.getElementById('eventDetailsModal');
  if (eventDetailsModal) {
    eventDetailsModal.style.display = 'flex';
  }

  // If we're missing important details, try to fetch them from the server
  if (displayDate === 'N/A' || displayTime === 'N/A' || displayAmenity === 'N/A') {
    fetchEventDetails(notification, displayEventName);
  }
}

function showAdminResponsePopup(message) {
  // Check if popup already exists and remove it
  const existingPopup = document.getElementById('adminResponsePopup');
  if (existingPopup) {
    document.body.removeChild(existingPopup);
  }

  // Create popup container
  const popup = document.createElement('div');
  popup.id = 'adminResponsePopup';
  popup.style.position = 'fixed';
  popup.style.top = '50%';
  popup.style.left = '50%';
  popup.style.transform = 'translate(-50%, -50%)';
  popup.style.backgroundColor = '#2d2d2d';
  popup.style.color = 'white';
  popup.style.padding = '20px';
  popup.style.borderRadius = '5px';
  popup.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
  popup.style.zIndex = '1000';
  popup.style.minWidth = '300px';
  popup.style.maxWidth = '80%';
  popup.style.display = 'flex';
  popup.style.flexDirection = 'column';

  // Create header with hostname
  const header = document.createElement('div');
  header.style.display = 'flex';
  header.style.alignItems = 'center';
  header.style.marginBottom = '15px';
  
  const icon = document.createElement('span');
  icon.innerHTML = 'ðŸŒ';
  icon.style.marginRight = '5px';
  
  const hostname = document.createElement('span');
  hostname.textContent = 'localhost:3000';
  hostname.style.fontSize = '14px';
  hostname.style.opacity = '0.8';
  
  header.appendChild(icon);
  header.appendChild(hostname);
  
  // Create message content
  const content = document.createElement('div');
  content.textContent = message;
  content.style.marginBottom = '20px';
  content.style.lineHeight = '1.5';
  
  // Create OK button
  const buttonContainer = document.createElement('div');
  buttonContainer.style.display = 'flex';
  buttonContainer.style.justifyContent = 'flex-end';
  
  const okButton = document.createElement('button');
  okButton.textContent = 'OK';
  okButton.style.backgroundColor = '#00bcd4';
  okButton.style.color = 'white';
  okButton.style.border = 'none';
  okButton.style.borderRadius = '4px';
  okButton.style.padding = '8px 16px';
  okButton.style.cursor = 'pointer';
  okButton.style.fontWeight = 'bold';
  okButton.onclick = function() {
    document.body.removeChild(popup);
  };
  
  buttonContainer.appendChild(okButton);
  
  // Add overlay
  const overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.top = '0';
  overlay.style.left = '0';
  overlay.style.width = '100%';
  overlay.style.height = '100%';
  overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
  overlay.style.zIndex = '999';
  overlay.onclick = function() {
    document.body.removeChild(overlay);
    document.body.removeChild(popup);
  };
  
  // Assemble popup
  popup.appendChild(header);
  popup.appendChild(content);
  popup.appendChild(buttonContainer);
  
  // Add to document
  document.body.appendChild(overlay);
  document.body.appendChild(popup);
}


function handleNoNotifications() {
  console.log("Handling no notifications");
  notifications = [];
  const notificationCountElement = document.getElementById('notificationCount');
  if (notificationCountElement) {
    notificationCountElement.textContent = '0';
  }
  updateNotificationList();
  updateClearButtons();
}
function updateClearButtons() {
  console.log("Updating clear buttons");
  const clearSelectedBtn = document.getElementById('clearSelectedBtn');
  const clearAllBtn = document.getElementById('clearAllBtn');

  if (!clearSelectedBtn || !clearAllBtn) {
    console.error('Clear buttons not found');
    return; // Buttons not found
  }

  if (notifications.length === 0) {
    clearSelectedBtn.disabled = true;
    clearAllBtn.disabled = true;
    clearSelectedBtn.style.opacity = '0.5';
    clearAllBtn.style.opacity = '0.5';
  } else {
    clearSelectedBtn.disabled = false;
    clearAllBtn.disabled = false;
    clearSelectedBtn.style.opacity = '1';
    clearAllBtn.style.opacity = '1';
  }
}

// Function to show error messages
function showErrorMessage(message) {
  console.error('Error message:', message);
  const errorDiv = document.createElement('div');
  errorDiv.textContent = message;
  errorDiv.style.color = 'red';
  errorDiv.style.padding = '10px';
  errorDiv.style.marginTop = '10px';
  errorDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.1)';
  errorDiv.style.border = '1px solid red';
  errorDiv.style.borderRadius = '5px';

  // Find a good place to add the error message
  const notificationList = document.getElementById('notificationList');
  if (notificationList) {
    notificationList.prepend(errorDiv);
  } else {
    document.body.appendChild(errorDiv);
  }

  setTimeout(() => {
    if (errorDiv.parentNode) {
      errorDiv.parentNode.removeChild(errorDiv);
    }
  }, 5000); // Remove after 5 seconds
}

function proceedToPayment(notification) {
  // Check if this is a deleted event notification
  if (notification.type === 'event_deleted') {
    alert('This event has been deleted and is no longer available for payment.');
    return;
  }

  if (!notification.relatedId) {
    console.error("Missing relatedId in notification:", notification);
    alert('Error: Missing event ID. Please contact support.');
    return;
  }
  
  const eventId = notification.relatedId;
  console.log("Proceeding to payment for event ID:", eventId);
  
  const loadingDiv = document.createElement('div');
  loadingDiv.textContent = 'Loading event details...';
  loadingDiv.style.position = 'fixed';
  loadingDiv.style.top = '50%';
  loadingDiv.style.left = '50%';
  loadingDiv.style.transform = 'translate(-50%, -50%)';
  loadingDiv.style.padding = '20px';
  loadingDiv.style.background = 'white';
  loadingDiv.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
  loadingDiv.style.borderRadius = '5px';
  loadingDiv.style.zIndex = '9999';
  document.body.appendChild(loadingDiv);
  
  // First try to use the notification data directly if it has all needed fields
  if (notification.eventName && notification.eventDate && 
      notification.startTime && notification.endTime && notification.amenity) {
    
    console.log("Using notification data directly for payment");
    const eventData = {
      _id: notification.relatedId,
      userEmail: notification.userEmail,
      eventName: notification.eventName,
      eventDate: notification.eventDate,
      startTime: notification.startTime,
      endTime: notification.endTime,
      amenity: notification.amenity
    };
    
    document.body.removeChild(loadingDiv);
    sessionStorage.setItem('eventData', JSON.stringify(eventData));
    window.location.href = 'payment.html';
    return;
  }
  
  // Otherwise, fetch from server
  fetch(`/api/event/${eventId}`)
    .then(response => {
      if (!response.ok) {
        if (response.status === 404 && notification.userEmail) {
          console.log("Event not found by ID, trying by user email:", notification.userEmail);
          return fetch(`/api/user-events/${encodeURIComponent(notification.userEmail)}`);
        }
        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        let eventData;
        
        if (data.event) {
          eventData = data.event;
        } else if (data.events && data.events.length > 0) {
          // Find the matching event by ID
          eventData = data.events.find(event => event._id.toString() === eventId);
          if (!eventData) {
            throw new Error("Matching event not found in user's events");
          }
        } else {
          throw new Error("No event data found");
        }
        
        console.log("Event data to use:", eventData);
        sessionStorage.setItem('eventData', JSON.stringify(eventData));
        document.body.removeChild(loadingDiv);
        window.location.href = 'payment.html';
      } else {
        throw new Error(data.message || "Unknown error");
      }
    })
    .catch(error => {
      console.error('Error fetching event details:', error);
      
      if (document.body.contains(loadingDiv)) {
        document.body.removeChild(loadingDiv);
      }
      
      const useManualEntry = confirm(
        'Failed to fetch event details automatically. Would you like to enter event details manually?\n\n' +
        'Error: ' + error.message
      );
      
      if (useManualEntry) {
        const minimalEvent = {
          userEmail: notification.userEmail || '',
          eventName: notification.eventName || 'Unknown Event',
          eventDate: notification.eventDate || new Date().toISOString().split('T')[0],
          startTime: notification.startTime || '09:00',
          endTime: notification.endTime || '12:00',
          amenity: notification.amenity || 'Unknown',
        };
        
        sessionStorage.setItem('eventData', JSON.stringify(minimalEvent));
        window.location.href = 'payment.html';
      }
    });
}

// Function to clear all notifications
async function clearAllNotifications() {
  console.log("Clearing all notifications");
  try {
    const response = await fetch('/api/clearAllNotifications', {
      method: 'POST',
      credentials: 'include'
    });

    if (response.ok) {
      const result = await response.json();
      if (result.success) {
        notifications = [];
        const notificationCount = document.getElementById('notificationCount');
        if (notificationCount) {
          notificationCount.textContent = '0';
        }
        updateNotificationList();
        updateClearButtons();
      }
    }
  } catch (error) {
    console.error('Error clearing all notifications:', error);
    showErrorMessage('Failed to clear notifications. Please try again.');
  }
}

// Function to clear selected notifications
async function clearSelectedNotifications() {
  console.log("Clearing selected notifications");
  try {
    const checkboxes = document.querySelectorAll('.notification-checkbox:checked');
    if (checkboxes.length === 0) {
      console.log("No notifications selected");
      return;
    }

    const selectedIds = Array.from(checkboxes).map(checkbox => checkbox.dataset.id);
    console.log("Selected notification IDs:", selectedIds);

    const response = await fetch('/api/clearSelectedNotifications', {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ notificationIds: selectedIds })
    });

    if (response.ok) {
      const result = await response.json();
      if (result.success) {
        // Remove the cleared notifications from the array
        notifications = notifications.filter(notification => 
          !selectedIds.includes(notification._id)
        );
        
        // Update the notification count
        const notificationCount = document.getElementById('notificationCount');
        if (notificationCount) {
          notificationCount.textContent = notifications.length.toString();
        }
        
        // Update the UI
        updateNotificationList();
        updateClearButtons();
      }
    }
  } catch (error) {
    console.error('Error clearing selected notifications:', error);
    showErrorMessage('Failed to clear selected notifications. Please try again.');
  }
}

// Function to fetch notifications from the server
async function fetchNotifications() {
  console.log("Fetching notifications");
  try {
    console.log("Attempting to fetch notifications...");
    const response = await fetch('/api/notifications', {
      method: 'GET',
      credentials: 'include', // Important: This ensures cookies are sent with the request
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    });

    console.log("Fetch response received:", response);
    
    if (!response.ok) {
      // If we get a 401, try to redirect to login
      if (response.status === 401) {
        console.log("User not authenticated, redirecting to login page");
        window.location.href = '/Webpages/login.html';
        return;
      }
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const responseText = await response.text();
    console.log("Response text:", responseText);

    let data;
    try {
      data = JSON.parse(responseText);
    } catch (parseError) {
      console.error("Error parsing JSON:", parseError);
      throw new Error("Invalid JSON response");
    }
    
    if (data.success) {
      notifications = data.notifications || [];
      const notificationCountElement = document.getElementById('notificationCount');
      if (notificationCountElement) {
        notificationCountElement.textContent = data.unreadCount || '0';
      }
      updateNotificationList();
      updateClearButtons();
      retryCount = 0; // Reset retry count on successful fetch
    } else {
      throw new Error(data.error || 'Failed to fetch notifications');
    }
  } catch (error) {
    console.error('Detailed error in fetchNotifications:', error);
    
    if (error instanceof TypeError && error.message.includes('NetworkError')) {
      if (retryCount < MAX_RETRIES) {
        retryCount++;
        console.log(`Retrying fetch (${retryCount}/${MAX_RETRIES})...`);
        setTimeout(fetchNotifications, RETRY_DELAY);
      } else {
        showErrorMessage('Network error occurred. Please check your internet connection and try again.');
        notifications = [];
        updateNotificationList();
        updateClearButtons();
      }
    } else {
      showErrorMessage('Failed to fetch notifications. Please try again later.');
      notifications = [];
      updateNotificationList();
      updateClearButtons();
    }
  }
}

// Wait for DOM to be fully loaded before running any code
document.addEventListener('DOMContentLoaded', function() {
  console.log("DOM fully loaded, initializing notification system");

  try {
    // Initialize notification elements
    const notificationIcon = document.getElementById('notificationIcon');
    const notificationModal = document.getElementById('notificationModal');
    const closeModal = document.getElementById('closeModal');
    const closeEventDetails = document.getElementById('closeEventDetails');
    const clearSelectedBtn = document.getElementById('clearSelectedBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const notificationCount = document.getElementById('notificationCount');
    const notificationList = document.getElementById('notificationList');
    const eventDetailsModal = document.getElementById('eventDetailsModal');
    
    console.log("Notification elements:", {
      notificationIcon: !!notificationIcon,
      notificationModal: !!notificationModal,
      closeModal: !!closeModal,
      closeEventDetails: !!closeEventDetails,
      clearSelectedBtn: !!clearSelectedBtn,
      clearAllBtn: !!clearAllBtn,
      notificationCount: !!notificationCount,
      notificationList: !!notificationList,
      eventDetailsModal: !!eventDetailsModal
    });
    
    // Set up event listeners
    if (notificationIcon) {
      notificationIcon.addEventListener('click', () => {
        console.log("Notification icon clicked");
        if (notificationModal) {
          notificationModal.style.display = 'block';
          updateNotificationList();
        }
      });
    }
    
    if (closeModal) {
      closeModal.addEventListener('click', () => {
        console.log("Close modal clicked");
        if (notificationModal) {
          notificationModal.style.display = 'none';
        }
      });
    }
    
    if (closeEventDetails) {
      closeEventDetails.addEventListener('click', () => {
        console.log("Close event details clicked");
        if (eventDetailsModal) {
          eventDetailsModal.style.display = 'none';
        }
      });
    }
    
    if (clearSelectedBtn) {
      clearSelectedBtn.addEventListener('click', clearSelectedNotifications);
    }
    
    if (clearAllBtn) {
      clearAllBtn.addEventListener('click', clearAllNotifications);
    }
    
    // Close modals when clicking outside
    window.addEventListener('click', (event) => {
      if (notificationModal && event.target === notificationModal) {
        notificationModal.style.display = 'none';
      }
      if (eventDetailsModal && event.target === eventDetailsModal) {
        eventDetailsModal.style.display = 'none';
      }
    });
    
    // Initialize admin popup functionality
    const adminButton = document.getElementById("adminbutton");
    const popup = document.getElementById("adminPopup");
    const closePopup = document.getElementById("closePopup");
    const form = document.getElementById("adminForm");
    
    if (adminButton) {
      adminButton.addEventListener("click", () => {
        if (popup) {
          popup.style.display = "flex";
        }
      });
    }
    
    if (closePopup) {
      closePopup.addEventListener("click", () => {
        if (popup) {
          popup.style.display = "none";
          if (form) {
            form.reset();
          }
        }
      });
    }
    
    // Initialize logout button
    const logoutButton = document.getElementById('logoutButton');
    if (logoutButton) {
      logoutButton.addEventListener('click', async () => {
        try {
          const response = await fetch('/logout', { method: 'POST' });
          if (response.ok) {
            localStorage.clear(); // Clear user data
            window.location.href = 'login.html'; // Redirect to the login page
          } else {
            showErrorMessage('Logout failed. Please try again.');
          }
        } catch (error) {
          console.error('Error during logout:', error);
          showErrorMessage('An error occurred during logout. Please try again.');
        }
      });
    }
    
    // Handle form submission for admin concerns
    if (document.getElementById('adminForm')) {
      document.getElementById('adminForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        
        const subject = document.getElementById('subject').value;
        const message = document.getElementById('message').value;
        const fileInput = document.getElementById('fileInput');
        const selectedFile = fileInput?.files?.[0];
        let fileData = null;

        if (selectedFile) {
          const reader = new FileReader();

          reader.onloadend = async function () {
            // Prepare the file data as base64 for sending
            fileData = reader.result.split(',')[1]; // Get base64 part after the comma

            const concernData = {
              username: localStorage.getItem('username'),
              email: localStorage.getItem('email'),
              subject: subject,
              message: message,
              createdAt: new Date().toISOString().replace('Z', '+00:00'),
              file: fileData,
            };

            try {
              const response = await fetch('/addconcern', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(concernData),
              });

              const result = await response.json();

              if (result.success) {
                alert("Your concern has been submitted successfully!");
                document.getElementById('adminForm').reset();
                document.getElementById('adminPopup').style.display = "none";
              } else {
                alert("Failed to submit the concern. Please try again.");
              }
            } catch (error) {
              console.error('Error submitting concern:', error);
              alert("There was an error submitting your concern. Please try again.");
            }
          };

          reader.readAsDataURL(selectedFile); // Read file as Data URL
        } else {
          const concernData = {
            username: localStorage.getItem('username'),
            email: localStorage.getItem('email'),
            subject: subject,
            message: message,
            createdAt: new Date().toISOString().replace('Z', '+00:00'),
          };

          try {
            const response = await fetch('/addconcern', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(concernData),
            });

            const result = await response.json();

            if (result.success) {
              alert("Your concern has been submitted successfully!");
              document.getElementById('adminForm').reset();
              document.getElementById('adminPopup').style.display = "none";
            } else {
              alert("Failed to submit the concern. Please try again.");
            }
          } catch (error) {
            console.error('Error submitting concern:', error);
            alert("There was an error submitting your concern. Please try again.");
          }
        }
      });
    }
    // Fetch notifications initially
    console.log("Initializing first notification fetch");
    fetchNotifications();
    
    // Set up periodic fetching (every 30 seconds)
    setInterval(fetchNotifications, 30000);
    
  } catch (error) {
    console.error("Error during initialization:", error);
    showErrorMessage("Failed to initialize notification system. Please refresh the page.");
  }
});

// Function to handle image loading errors
function handleImageError(img) {
  console.error('Failed to load image:', img.src);
  
  // If the image is already using the fallback path, use a data URI placeholder
  if (img.src.includes('/images/')) {
    img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjAiIGZpbGw9IiNhYWEiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5JbWFnZSBub3QgZm91bmQ8L3RleHQ+PC9zdmc+';
    return;
  }
  
  // Try the /images/ path first
  const imageName = img.src.split('/').pop();
  img.src = `/images/${imageName}`;
}

// Add a global error handler to catch any uncaught errors
window.addEventListener('error', function(event) {
  console.error('Global error caught:', event.error);
  showErrorMessage(`An error occurred: ${event.error?.message || 'Unknown error'}`);
});

console.log("Script loaded successfully");
  </script>
</html>

