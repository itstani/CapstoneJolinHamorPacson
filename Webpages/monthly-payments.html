<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monthly Dues Payments</title>
  <link rel="stylesheet" type="text/css" href="../CSS/styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f8f8;
    }

    .top-bar {
      background-color: #AF2630;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      width: 100%;
      height: 50px;
      z-index: 1000;
    }

    .side-bar {
      background-color: #d9d9d9;
      position: fixed;
      color: #AF2630;
      top: 50px;
      left: 0;
      width: 110px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 5px;
      box-sizing: border-box;
      z-index: 900;
    }

    .side-bar div {
      margin-bottom: 20px;
      text-align: center;
      font-size: 15px;
      font-weight: bold;
    }

    .side-bar button {
      background-color: #d9d9d9;
      margin: 0 auto;
      border: none;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      cursor: pointer;
    }

    .side-bar button:hover {
      background-color: #ccc;
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .side-bar img {
      width: 60px;
      height: 60px;
    }

    #logoutButton {
      background-color: #AF2630;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: auto;
      margin-bottom: 90px;
      font-weight: bold;
    }

    #logoutButton:hover {
      background-color: #c44a53;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      transform: translateY(-3px);
    }

    .main-content {
      margin-left: 110px;
      padding: 70px 20px 20px;
    }

    h1 {
      color: #AF2630;
      margin-bottom: 20px;
    }

    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border: 1px solid #ddd;
      border-bottom: none;
      border-radius: 5px 5px 0 0;
      margin-right: 5px;
      background-color: #f1f1f1;
      font-weight: 500;
    }

    .tab.active {
      background-color: #AF2630;
      color: white;
      border-color: #AF2630;
    }

    .search-bar {
      display: flex;
      margin-bottom: 20px;
    }

    .search-bar input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px 0 0 5px;
      font-size: 16px;
    }

    .search-bar button {
      padding: 10px 20px;
      background-color: #AF2630;
      color: white;
      border: none;
      border-radius: 0 5px 5px 0;
      cursor: pointer;
    }
    /* Days overdue styling */
.days-overdue {
  display: inline-block;
  padding: 2px 6px;
  margin-top: 4px;
  border-radius: 3px;
  font-size: 12px;
  font-weight: 500;
}

.overdue-mild {
  background-color: #fff3cd;
  color: #856404;
  border: 1px solid #ffeeba;
}

.overdue-moderate {
  background-color: #ffe5d0;
  color: #c66a10;
  border: 1px solid #ffd5b5;
}

.overdue-severe {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

    .payments-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border-radius: 5px;
      overflow: hidden;
    }

    .payments-table th {
      background-color: #f1f1f1;
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #ddd;
    }

    .payments-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #ddd;
    }

    .payments-table tr:last-child td {
      border-bottom: none;
    }

    .payments-table tr:hover {
      background-color: #f9f9f9;
    }

    .status {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      display: inline-block;
    }

    .status-pending {
      background-color: #FFF3CD;
      color: #856404;
    }

    .status-approved {
      background-color: #D4EDDA;
      color: #155724;
    }

    .status-rejected {
      background-color: #F8D7DA;
      color: #721C24;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
    }

    .btn-approve {
      background-color: #28A745;
      color: white;
    }

    .btn-reject {
      background-color: #DC3545;
      color: white;
    }

    .btn-view {
      background-color: #17A2B8;
      color: white;
    }

    .delinquent-days {
  display: inline-block;
  background-color: #AF2630;
  color: white;
  font-size: 12px;
  font-weight: bold;
  padding: 3px 8px;
  border-radius: 12px;
  margin-left: 8px;
}

.days-count {
  font-weight: bold;
}

.due-warning {
  color: #856404;
}

.due-critical {
  color: #721C24;
}

    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }

    .pagination button {
      padding: 8px 15px;
      margin: 0 5px;
      background-color: #f1f1f1;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
    }

    .pagination button.active {
      background-color: #AF2630;
      color: white;
      border-color: #AF2630;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .empty-state p {
      color: #666;
      font-size: 16px;
      margin-bottom: 20px;
    }

    .loading {
      text-align: center;
      padding: 40px;
    }

    .error-state {
      text-align: center;
      padding: 40px;
      background-color: #f8d7da;
      border-radius: 5px;
      color: #721c24;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 5px;
      width: 50%;
      max-width: 500px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      margin: 0;
      color: #333;
    }

    .close-modal {
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .modal-body label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .modal-body textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      resize: vertical;
      min-height: 100px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Receipt viewer */
    .receipt-container {
      text-align: center;
      margin-top: 20px;
    }

    .receipt-image {
      max-width: 100%;
      max-height: 400px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .payment-details {
      margin-top: 20px;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 5px;
      border-left: 4px solid #AF2630;
    }

    .payment-details p {
      margin: 8px 0;
    }

    .payment-details strong {
      font-weight: 600;
    }

  .delinquent-days {
    display: inline-block;
    background-color: #AF2630;
    color: white;
    font-size: 12px;
    font-weight: bold;
    padding: 3px 8px;
    border-radius: 12px;
    margin-left: 8px;
  }
  
  .days-count {
    font-weight: bold;
  }
  
  .due-warning {
    color: #856404;
  }
  
  .due-critical {
    color: #721C24;
  }
  </style>
</head>
<body>
  <div class="top-bar"></div>
  
  <div class="side-bar">
    <div class="Home">
      <button type="button" id="homebutton" name="homebutton" aria-label="home" onclick="window.location.href='AdHome.html'">
        <img src="/images/house.png" alt="Home">
      </button>
      <p>Home</p>
    </div>
    <div class="homeownerstatus">
      <button type="button" id="Documentsbutton" name="Documentsbutton" aria-label="Documents" onclick="window.location.href='hotable.html'">
        <img src="/images/Documents.png" alt="Documents">
      </button>
      <p>Homeowner status</p>
    </div>
    <div class="analytics">
      <button type="button" id="analyticsbutton" name="analyticsbutton" aria-label="analytics" onclick="window.location.href='analytics.html'">
        <img src="/images/Data.png" alt="Analytics">
      </button>
      <p>Analytics</p>
    </div>
    <div class="Calendar">
      <button type="button" id="Calendarbutton" name="Calendarbutton" aria-label="Calendar" onclick="window.location.href='admincalender.html'">
        <img src="/images/Calendar.png" alt="Calendar">
      </button>
      <p>Calendar</p>
    </div>
    <div class="MonthlyPayments">
      <button type="button" id="MonthlyPaymentsButton" name="MonthlyPaymentsButton" aria-label="Monthly Payments" onclick="window.location.href='Monthly-payments.html'">
        <img src="/images/payment.png" alt="Monthly Payments" onerror="this.src='/images/Documents.png';">
      </button>
      <p>Monthly Payments</p>
    </div>
    <button id="logoutButton" class="logoutButton">Logout</button>
  </div>

  <div class="main-content">
    <h1>Monthly Dues Payments</h1>
    
    <div class="tabs">
      <div class="tab active" data-status="all">All Payments</div>
      <div class="tab" data-status="pending">Pending</div>
      <div class="tab" data-status="approved">Approved</div>
      <div class="tab" data-status="rejected">Rejected</div>
      <div class="tab" data-status="due">Due Payments</div>
    </div>
    
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search by homeowner name or email...">
      <button id="searchButton">Search</button>
    </div>
    
    <div id="paymentsContainer">
      <!-- Content will be loaded dynamically -->
      <div class="loading">Loading payments...</div>
    </div>
    
    <div class="pagination" id="pagination">
      <!-- Pagination will be generated dynamically -->
    </div>
  </div>

  <!-- Reject Payment Modal -->
  <div id="rejectModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Reject Payment</h2>
        <span class="close-modal" id="closeRejectModal">&times;</span>
      </div>
      <div class="modal-body">
        <label for="rejectionReason">Reason for rejection:</label>
        <textarea id="rejectionReason" placeholder="Please provide a reason for rejecting this payment..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn" id="cancelReject">Cancel</button>
        <button class="btn btn-reject" id="confirmReject">Reject Payment</button>
      </div>
    </div>
  </div>

  <!-- View Payment Modal -->
  <div id="viewModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Payment Details</h2>
        <span class="close-modal" id="closeViewModal">&times;</span>
      </div>
      <div class="modal-body" id="paymentDetails">
        <!-- Payment details will be loaded here -->
      </div>
      <div class="modal-footer">
        <button class="btn" id="closeViewButton">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Global variables
let currentStatus = "all";
let currentPage = 1;
let totalPages = 1;
let searchTerm = "";

// Initialize the page
document.addEventListener("DOMContentLoaded", function() {
  // Set up tab click handlers
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const status = this.dataset.status;
      switchTab(status);
    });
  });

  // Set up search input handler
  document.getElementById('searchInput').addEventListener('input', function() {
    searchTerm = this.value;
    currentPage = 1;
    loadPayments();
  });

  // Load initial payments
  loadPayments();
});

// Function to switch tabs
function switchTab(status) {
  // Update active tab
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelector(`.tab[data-status="${status}"]`).classList.add('active');
  
  // Update current status and reset to page 1
  currentStatus = status;
  currentPage = 1;
  
  // Load payments for the selected status
  loadPayments();
}

// Function to load payments
async function loadPayments() {
  try {
    // Show loading state
    document.getElementById('paymentsTableBody').innerHTML = `
      <tr>
        <td colspan="6" class="text-center">Loading payments...</td>
      </tr>
    `;
    
    // Build query parameters
    const params = new URLSearchParams({
      status: currentStatus,
      page: currentPage,
      limit: 10
    });
    
    if (searchTerm) {
      params.append('search', searchTerm);
    }
    
    // Fetch payments from API
    const response = await fetch(`/api/monthly-payments?${params.toString()}`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.success) {
      // Update pagination info
      totalPages = data.totalPages;
      updatePagination();
      
      // Render payments
      renderPayments(data.payments);
    } else {
      throw new Error(data.message || 'Failed to load payments');
    }
  } catch (error) {
    console.error('Error loading payments:', error);
    document.getElementById('paymentsTableBody').innerHTML = `
      <tr>
        <td colspan="6" class="text-center text-danger">
          Error loading payments. Please try again.
        </td>
      </tr>
    `;
  }
}

// Function to render payments
function renderPayments(payments) {
  const tableBody = document.getElementById('paymentsTableBody');
  
  if (!payments || payments.length === 0) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center">No payments found.</td>
      </tr>
    `;
    return;
  }
  
  tableBody.innerHTML = '';
  
  payments.forEach(payment => {
    const row = document.createElement('tr');
    
    // Format date
    const date = new Date(payment.timestamp).toLocaleDateString();
    const time = new Date(payment.timestamp).toLocaleTimeString();
    
    // Determine status class
    let statusClass = 'badge-secondary';
    if (payment.status === 'approved') {
      statusClass = 'badge-success';
    } else if (payment.status === 'rejected') {
      statusClass = 'badge-danger';
    } else if (payment.status === 'pending') {
      statusClass = 'badge-warning';
    }
    
    // Create days overdue element if applicable
    let daysOverdueHtml = '';
    if (currentStatus === 'due' && payment.daysOverdue) {
      const severityClass = payment.daysOverdue > 60 ? 'overdue-severe' : 
                           payment.daysOverdue > 30 ? 'overdue-moderate' : 'overdue-mild';
      daysOverdueHtml = `<div class="days-overdue ${severityClass}">${payment.daysOverdue} days overdue</div>`;
    }
    
    row.innerHTML = `
      <td>
        ${payment.userName || 'N/A'}
        <div class="small text-muted">${payment.userEmail || 'No email'}</div>
        ${daysOverdueHtml}
      </td>
      <td>₱${payment.amount || '0.00'}</td>
      <td>${payment.paymentMethod || 'N/A'}</td>
      <td>
        ${date}<br>
        <span class="small text-muted">${time}</span>
      </td>
      <td><span class="badge ${statusClass}">${payment.status || 'unknown'}</span></td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="viewPayment('${payment._id}')">
          View
        </button>
        ${payment.status === 'pending' ? `
          <button class="btn btn-sm btn-success ml-1" onclick="approvePayment('${payment._id}')">
            Approve
          </button>
          <button class="btn btn-sm btn-danger ml-1" onclick="rejectPayment('${payment._id}')">
            Reject
          </button>
        ` : ''}
      </td>
    `;
    
    tableBody.appendChild(row);
  });
}

// Function to update pagination
function updatePagination() {
  const paginationElement = document.getElementById('pagination');
  
  if (totalPages <= 1) {
    paginationElement.innerHTML = '';
    return;
  }
  
  let paginationHtml = `
    <button class="btn btn-sm btn-outline-secondary" 
            onclick="changePage(${currentPage - 1})" 
            ${currentPage === 1 ? 'disabled' : ''}>
      Previous
    </button>
    <span class="mx-2">Page ${currentPage} of ${totalPages}</span>
    <button class="btn btn-sm btn-outline-secondary" 
            onclick="changePage(${currentPage + 1})" 
            ${currentPage === totalPages ? 'disabled' : ''}>
      Next
    </button>
  `;
  
  paginationElement.innerHTML = paginationHtml;
}

// Function to change page
function changePage(page) {
  if (page < 1 || page > totalPages) {
    return;
  }
  
  currentPage = page;
  loadPayments();
}

// Function to view payment details
async function viewPayment(paymentId) {
  try {
    const response = await fetch(`/api/monthly-payments/${paymentId}`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.success) {
      const payment = data.payment;
      
      // Populate modal with payment details
      document.getElementById('paymentDetailsUserName').textContent = payment.userName || 'N/A';
      document.getElementById('paymentDetailsUserEmail').textContent = payment.userEmail || 'N/A';
      document.getElementById('paymentDetailsAmount').textContent = `₱${payment.amount || '0.00'}`;
      document.getElementById('paymentDetailsMethod').textContent = payment.paymentMethod || 'N/A';
      document.getElementById('paymentDetailsDate').textContent = new Date(payment.timestamp).toLocaleString();
      document.getElementById('paymentDetailsStatus').textContent = payment.status || 'unknown';
      
      // Set status badge class
      const statusBadge = document.getElementById('paymentDetailsStatusBadge');
      statusBadge.className = 'badge';
      if (payment.status === 'approved') {
        statusBadge.classList.add('badge-success');
      } else if (payment.status === 'rejected') {
        statusBadge.classList.add('badge-danger');
      } else if (payment.status === 'pending') {
        statusBadge.classList.add('badge-warning');
      } else {
        statusBadge.classList.add('badge-secondary');
      }
      
      // Show receipt image if available
      const receiptContainer = document.getElementById('receiptImageContainer');
      if (payment.receiptImage) {
        receiptContainer.innerHTML = `<img src="${payment.receiptImage}" class="img-fluid" alt="Receipt">`;
        receiptContainer.style.display = 'block';
      } else {
        receiptContainer.style.display = 'none';
      }
      
      // Set payment ID for approve/reject buttons
      document.getElementById('approvePaymentBtn').setAttribute('data-id', payment._id);
      document.getElementById('rejectPaymentBtn').setAttribute('data-id', payment._id);
      
      // Show/hide approve/reject buttons based on status
      const actionButtons = document.getElementById('paymentActionButtons');
      if (payment.status === 'pending') {
        actionButtons.style.display = 'block';
      } else {
        actionButtons.style.display = 'none';
      }
      
      // Show modal
      $('#paymentDetailsModal').modal('show');
    } else {
      throw new Error(data.message || 'Failed to load payment details');
    }
  } catch (error) {
    console.error('Error loading payment details:', error);
    alert('Error loading payment details. Please try again.');
  }
}

// Function to approve payment
async function approvePayment(paymentId) {
  if (!confirm('Are you sure you want to approve this payment?')) {
    return;
  }
  
  try {
    const response = await fetch(`/api/monthly-payments/${paymentId}/approve`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.success) {
      alert('Payment approved successfully!');
      // Close modal if open
      $('#paymentDetailsModal').modal('hide');
      // Reload payments
      loadPayments();
    } else {
      throw new Error(data.message || 'Failed to approve payment');
    }
  } catch (error) {
    console.error('Error approving payment:', error);
    alert('Error approving payment. Please try again.');
  }
}

// Function to reject payment
async function rejectPayment(paymentId) {
  const reason = prompt('Please enter a reason for rejecting this payment:');
  
  if (reason === null) {
    return; // User cancelled
  }
  
  if (!reason.trim()) {
    alert('A reason is required to reject a payment.');
    return;
  }
  
  try {
    const response = await fetch(`/api/monthly-payments/${paymentId}/reject`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ reason })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.success) {
      alert('Payment rejected successfully!');
      // Close modal if open
      $('#paymentDetailsModal').modal('hide');
      // Reload payments
      loadPayments();
    } else {
      throw new Error(data.message || 'Failed to reject payment');
    }
  } catch (error) {
    console.error('Error rejecting payment:', error);
    alert('Error rejecting payment. Please try again.');
  }
}
  
  </script>
  
</body>
</html>
